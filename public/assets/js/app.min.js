function trimLeft(e,t){if(!t||" "==t)return $.trim(e);for(;0==e.indexOf(t);)e=e.substring(t.length);return e}function json(str){return eval("("+str+")")}function t(){var e=arguments;if(e.length<=1)return e[0];var t=e[0];if(!t)return t;var o="LEAAEL";t=t.replace(/\?/g,o);for(var a=1;a<=e.length;++a)t=t.replace(o,e[a]);return t}function arrayEqual(e,t){return e=e||[],t=t||[],e.join(",")==t.join(",")}function isArray(e){return"[object Array]"===Object.prototype.toString.call(e)}function isEmpty(e){return e?isArray(e)&&0==e.length?!0:!1:!0}function getFormJsonData(e){var t=formArrDataToJson($("#"+e).serializeArray());return t}function formArrDataToJson(e){var t={},o={};for(var a in e){var n=e[a].name,r=e[a].value;"[]"!=n.substring(n.length-2,n.length)?t[n]=r:(n=n.substring(0,n.length-2),void 0==o[n]?o[n]=[r]:o[n].push(r))}return $.extend(t,o)}function formSerializeDataToJson(e){for(var t=e.split("&"),o={},a={},n=0;n<t.length;++n){var r=t[n].split("="),i=decodeURI(r[0]),s=decodeURI(r[1]);"[]"!=i.substring(i.length-2,i.length)?o[i]=s:(i=i.substring(0,i.length-2),void 0==a[i]?a[i]=[s]:a[i].push(s))}return $.extend(o,a)}function _ajaxCallback(e,t,o){if(e===!0||"true"==e||"object"==typeof e){if(e&&"object"==typeof e&&"NOTLOGIN"==e.Msg)return void alert(getMsg("Please sign in firstly!"));"function"==typeof t&&t(e)}else"function"==typeof o?o(e):alert("error!")}function _ajax(e,t,o,a,n,r){return r="undefined"==typeof r?!0:!1,$.ajax({type:e,url:t,data:o,async:r,success:function(e){_ajaxCallback(e,a,n)},error:function(e){_ajaxCallback(e,a,n)}})}function ajaxGet(e,t,o,a,n){return _ajax("GET",e,t,o,a,n)}function ajaxPost(e,t,o,a,n){_ajax("POST",e,t,o,a,n)}function ajaxPostJson(e,t,o,a,n){n="undefined"==typeof n?!0:!1,$.ajax({url:e,type:"POST",contentType:"application/json; charset=utf-8",datatype:"json",async:n,data:JSON.stringify(t),success:function(e,t){_ajaxCallback(e,o,a)},error:function(e){_ajaxCallback(e,o,a)}})}function findParents(e,t){if($(e).is(t))return $(e);for(var o=$(e).parents(),a=0;a<o.length;++a)if(log(o.eq(a)),o.eq(a).is(t))return o.seq(a);return null}function getVendorPrefix(){for(var e=document.body||document.documentElement,t=e.style,o=["webkit","khtml","moz","ms","o"],a=0;a<o.length;){if("string"==typeof t[o[a]+"Transition"])return o[a];a++}}function switchEditor(e){$("#editor").show()}function setEditorContent(e,t,o,a){if(e||(e=""),clearIntervalForSetContent&&clearInterval(clearIntervalForSetContent),t)MD?(MD.setContent(e),MD.clearUndo&&MD.clearUndo(),a&&a()):clearIntervalForSetContent=setTimeout(function(){setEditorContent(e,!0,!1,a)},100);else if("undefined"!=typeof tinymce&&tinymce.activeEditor){var n=tinymce.activeEditor;n.setContent(e),a&&a(),n.undoManager.clear(),addDDListeners()}else clearIntervalForSetContent=setTimeout(function(){setEditorContent(e,!1,!1,a)},100);$(".ui-resizable-handle").remove()}function previewIsEmpty(e){return e&&e.substr(0,previewToken.length)!=previewToken?!1:!0}function isAceError(e){return e?-1!=e.indexOf("XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"):!1}function getEditorContent(e){var t=_getEditorContent(e);return'<p><br data-mce-bogus="1"></p>'===t?"<p><br></p>":t}function _getEditorContent(e){if(e)return[MD.getContent(),"<div>"+$("#preview-contents").html()+"</div>"];var t=tinymce.activeEditor;if(t){var o=$(t.getBody()).clone();if(o.find(".toggle-raw").remove(),window.LeaAce&&LeaAce.getAce)for(var a=o.find("pre"),n=0;n<a.length;++n){var r=a.eq(n),i=r.attr("id"),s=LeaAce.getAce(i);if(s){var l=s.getValue();isAceError(l)&&(l=r.html()),l=l.replace(/</g,"&lt").replace(/>/g,"&gt"),r.removeAttr("style","").removeAttr("contenteditable").removeClass("ace_editor"),r.html(l)}}if(o.find("pinit").remove(),o.find(".thunderpin").remove(),o.find(".pin").parent().remove(),o=$(o).html())for(;;){var c=o.lastIndexOf("</script>");if(-1==c)return o;var d=o.length;if(d-9!=c)return o;var h=o.lastIndexOf("<script ");if(-1==h&&(h=o.lastIndexOf("<script>")),-1==h)return o;o=o.substring(0,h)}return o}}function showDialog(e,t){$("#leanoteDialog #modalTitle").html(t.title),$("#leanoteDialog .modal-body").html($("#"+e+" .modal-body").html()),$("#leanoteDialog .modal-footer").html($("#"+e+" .modal-footer").html()),delete t.title,t.show=!0,$("#leanoteDialog").modal(t)}function hideDialog(e){e||(e=0),setTimeout(function(){$("#leanoteDialog").modal("hide")},e)}function closeDialog(){$(".modal").modal("hide")}function showDialog2(e,t){t=t||{},t.show=!0,$(e).modal(t)}function hideDialog2(e,t){t||(t=0),setTimeout(function(){$(e).modal("hide")},t)}function showDialogRemote(e,t){$("#groupInfoTable").empty(),$("#baseInfoTableBody").empty(),$("#shareMsg").empty();for(var o in group){var a=group[o],n='<tr data-id="'+a.GroupId+'" data-uid="">';n+="<td>"+a.GroupName+"</td>",n+='<td><label><input type="radio" name="perm_'+a.GroupId+'" checked="checked" value="0" class="group-perm">  <i class="fa fa-eye" aria-hidden="true"></i> Read Only </label><br/>',n+='<label><input type="radio" name="perm_'+a.GroupId+'" value="1" class="group-perm">  <i class="fa fa-pencil" aria-hidden="true"></i> Read and Write</label> </td>',n+='<td> <button id = "notsharebtn" class="btn btn-default btn-share-or-not"><i class="fa fa-share" aria-hidden="true"></i> Share</button> </td>',n+="</tr>",$("#groupInfoTable").append(n)}t=t||{},e+="?";for(var r in t)e+=r+"="+t[r]+"&";$("#leanoteDialogRemote").modal({})}function hideDialogRemote(e){e?setTimeout(function(){$("#leanoteDialogRemote").modal("hide")},e):$("#leanoteDialogRemote").modal("hide")}function notifyInfo(e){$.pnotify({title:"通知",text:e,type:"info",styling:"bootstrap"})}function notifyError(e){$.pnotify.defaults.delay=2e3,$.pnotify({title:"通知",text:e,type:"error",styling:"bootstrap"})}function notifySuccess(e){$.pnotify({title:"通知",text:e,type:"success",styling:"bootstrap"})}function goNowToDatetime(e){if(!e)return"";if("object"==typeof e)try{return e.format("yyyy-M-d hh:mm:ss")}catch(t){return getCurDate()}return e.substr(0,10)+" "+e.substr(11,8)}function getCurDate(){return(new Date).format("yyyy-MM-dd hh:mm:ss")}function enter(e,t,o){e||(e="body"),$(e).on("keydown",t,function(e){13==e.keyCode&&o.call(this)})}function enterBlur(e,t){e||(e="body"),t||(t=e,e="body"),$(e).on("keydown",t,function(e){13==e.keyCode&&$(this).trigger("blur")})}function getObjectId(){return ObjectId()}function showMsg(e,t){$("#msg").html(e),t&&setTimeout(function(){$("#msg").html("")},t)}function showMsg2(e,t,o){$(e).html(t),o&&setTimeout(function(){$(e).html("")},o)}function showAlert(e,t,o,a){$(e).html(t).removeClass("alert-danger").removeClass("alert-success").removeClass("alert-warning").addClass("alert-"+o).show(),a&&$(a).focus()}function hideAlert(e,t){t?setTimeout(function(){$(e).hide()},t):$(e).hide()}function post(e,t,o,a){a&&$(a).button("loading"),ajaxPost(e,t,function(e){a&&$(a).button("reset"),"object"==typeof e?"function"==typeof o&&o(e):alert("Q-Note出现了错误!")})}function isEmail(e){var t=/^([a-zA-Z0-9]+[_|\_|\.|\-]?)*[a-zA-Z0-9\-]+@([a-zA-Z0-9\-]+[_|\_|\.|\-]?)*[a-zA-Z0-9\-]+\.[0-9a-zA-Z]{2,3}$/;return t.test(e)}function isEmailFromInput(e,t,o,a){var n=$(e).val(),r=function(){};return t&&(r=function(t,o){showAlert(t,o,"danger",e)}),n?n:void r(t,o||getMsg("inputEmail"))}function initCopy(e,t){var o=new ZeroClipboard(document.getElementById(e),{moviePath:"/js/ZeroClipboard/ZeroClipboard.swf"});o.on("complete",function(e,o){t(o)})}function showLoading(){$("#loading").css("visibility","visible")}function hideLoading(){$("#loading").css("visibility","hidden")}function setCookie(e,t,o){var a=new Date;a.setDate(a.getDate()+o),document.cookie=e+"="+escape(t)+(null==o?"":";expires="+a.toGMTString())+"path=/",document.cookie=e+"="+escape(t)+(null==o?"":";expires="+a.toGMTString())+"path=/note"}function logout(){bootbox.confirm("Are you sure to quit now?",function(e){if(e){Note.curChangedSaveIt(!0),setCookie("QUICKNOTE_SESSION","",-1);var t={UserId:UserId},o=JSON.stringify(t),a=normUrl+"logOut";$.ajax({type:"POST",url:a,data:o,contentType:"text/plain",success:function(e){var t=jQuery.parseJSON(e);"success"==t.status||bootbox.alert(t.msg,function(){})},error:function(e,t,o){}}),location.href="login.html"}})}function getImageSize(e,t){function o(e,o){a.parentNode.removeChild(a),t({width:e,height:o})}var a=document.createElement("img");a.onload=function(){o(a.clientWidth,a.clientHeight)},a.onerror=function(){o()},a.src=e;var n=a.style;n.visibility="hidden",n.position="fixed",n.bottom=n.left=0,n.width=n.height="auto",document.body.appendChild(a)}function hiddenIframeBorder(){$(".mce-window iframe").attr("frameborder","no").attr("scrolling","no")}function getEmailLoginAddress(e){if(e){var t=e.split("@");if(t&&!(t.length<2)){var o=t[1];return email2LoginAddress[o]||"http://mail."+o}}}function reIsOk(e){return e&&"object"==typeof e&&e.Ok}function getHashObject(){var e=location.hash;if(!e)return{};for(var t=e.substr(1),o=t.split("&"),a={},n=0;n<o.length;++n){var r=o[n].split("=");2==r.length&&(a[r[0]]=r[1])}return a}function getHash(e,t){var o=getHashObject();return o[e]}function setHash(e,t){var o=location.hash;if(!o)return void(location.href="#"+e+"="+t);var a=getHashObject();a[e]=t;var n="";for(var r in a)a[r]&&(n&&(n+="&"),n+=r+"="+a[r]);location.href="#"+n}function initSlimScroll(){Mobile.isMobile()||($("#notebook").slimScroll({height:"100%"}),$("#noteItemList").slimScroll({height:"100%"}),$("#wmd-panel-preview").slimScroll({height:"100%"}),$("#wmd-panel-preview").css("width","100%"))}function scrollTo(e,t,o){var a=$("#editorContent"),n=a.find(t+":contains("+o+")");random++;for(var r=$('#leanoteNavContent [data-a="'+t+"-"+encodeURI(o)+'"]'),i=r.size(),s=0;i>s&&r[s]!=e;++s);if(n.size()>=s+1){n=n.eq(s);var l=a.scrollTop()-a.offset().top+n.offset().top;return void a.animate({scrollTop:l},300)}}function updateLeftIsMin(e){ajaxGet("/user/updateLeftIsMin",{leftIsMin:e})}function minLeft(e){$page.addClass("mini-left"),e&&updateLeftIsMin(!0)}function maxLeft(e){$page.removeClass("mini-left"),$("#noteAndEditor").css("left","12%"),$("#leftNotebook").width("12%"),e&&updateLeftIsMin(!1)}function getMaxDropdownHeight(e){var t=$(e).offset(),o=$(document).height()-t.top;o-=70,0>o&&(o=0);var a=$(e).find("ul").height();return o>a?a:o}function initPage(){if(console.log("initPage"),Notebook.renderNotebooks(notebooks),console.log("fst"),console.log(Notebook.cache),Share.renderShareNotebooks(sharedUserInfos,shareNotebooks),curSharedNoteNotebookId?Share.firstRenderShareNote(curSharedUserId,curSharedNoteNotebookId,curNoteId):(Note.setNoteCache(noteContentJson),Note.renderNotes(notes),curNoteId&&(setTimeout(function(){Note.changeNoteForPjax(curNoteId,!0,curNotebookId)}),curNotebookId||Notebook.selectNotebook($(tt('#notebook [notebookId="?"]',Notebook.allNotebookId))))),latestNotes.length>0)for(var e=0;e<latestNotes.length;++e)Note.addNoteCache(latestNotes[e]);Tag.renderTagNav(tagsJson),Tag.initializeTagHint(),LeaAce.handleEvent()}function revertTagStatus(){$("#addTagTrigger").show(),$("#addTagInput").hide()}function hideTagList(e){$("#tagDropdown").removeClass("open"),e&&e.stopPropagation()}function showTagList(e){$("#tagDropdown").addClass("open"),e&&e.stopPropagation()}function reRenderTags(){var e=["label label-default","label label-info"],t=0;$("#tags").children().each(function(){var o=$(this).attr("class");("label label-default"==o||"label label-info"==o)&&($(this).removeClass(o).addClass(e[t%2]),t++)})}function searchNotesByTagName(e){var t=[];for(var o in Note.cache)if(o){var a=Note.cache[o];if(void 0!=a.Tags){var n=a.Tags;for(var r in n)if(n[r]==e){t.push(a);break}}}return t}function addShareNoteOrNotebook(e){console.log(e);var t="#tr"+e,o=Share.dialogNoteOrNotebookId,a=isEmailFromInput(t+" #friendsEmail","#shareMsg",getMsg("friendEmailMissing"));if(a){var n=$(t+' input[name="perm'+e+'"]:checked').val()||0,r={NoteId:o,Email:a,Perm:n};if(console.log("share id is "+o),console.log("senderUserId is "+UserId),hideAlert("#shareMsg"),Share.dialogIsNote){console.log("share note");var r={SenderUserId:UserId,NoteId:o,Email:a,Perm:n},i=JSON.stringify(r),s=normUrl+"share/addShareNote";$.ajax({type:"POST",url:s,data:i,contentType:"text/plain",success:function(e){var n=jQuery.parseJSON(e);if("success"==n.status){console.log("success");var i=n.ToUserId;void 0==shareNotebookDefault[i]&&(shareNotebookDefault[i]=[]);var s=0;for(var l in shareNotebookDefault[i]){var c=shareNotebookDefault[i][l];if(c.NoteId==r.NoteId){showAlert("#shareMsg",getMsg("DoubleShared"),"danger"),s=1;break}}if(!s){shareNotebookDefault[i].push(r);var d={};d.id="test";var h=tt("");h+=tt("<td>?</td>",a),h+=tt('<td colspan = "2" id = "cancelbuttontd"><a href="#" noteOrNotebookId="?" id = "cancelbutton" toUserId="?" class="btn btn-warning delete-share"><i class="fa fa-user-times" aria-hidden="true"></i> Cancel</a></td>"',o,d.Id),$(t).html(h),showAlert("#shareMsg",getMsg("ShareSuccess"),"success")}}else showAlert("#shareMsg",n.msg,"danger")},error:function(e,t,o){console.log("Error: "+o.message),showAlert("#shareMsg",getMsg("ServerCrashes"),"danger")}})}else{var r={SenderUserId:UserId,NotebookId:o,Email:a,Perm:n},i=JSON.stringify(r),s=normUrl+"share/addShareNotebook";$.ajax({type:"POST",url:s,data:i,contentType:"text/plain",success:function(e){var n=jQuery.parseJSON(e);if("success"==n.status){console.log("success");var r={};r.id="test";var i=tt("<td>?</td>","#");i+=tt("<td>?</td>",a),i+=tt('<td><a href="#" noteOrNotebookId="?" toUserId="?" class="btn btn-warning delete-share">'+getMsg("delete")+"</a></td>",o,r.Id),$(t).html(i),showAlert("#shareMsg",getMsg("ShareSuccess"),"success")}else showAlert("#shareMsg",n.msg,"danger")},error:function(e,t,o){console.log("Error: "+o.message),$("#lblResponse").html(getMsg("ServerCrashes"))}})}}}function sendRegisterEmail(e){showDialog2("#sendRegisterEmailDialog",{postShow:function(){$("#emailContent").val(getMsg("inviteEmailBody",[UserInfo.Username,getMsg("app")])),setTimeout(function(){$("#emailContent").focus()},500),$("#toEmail").val(e)}})}function deleteShareNoteOrNotebook(e){$("#tr"+e).remove()}function transform(e){var t=[];for(var o in e)t.push(e[o]);return t}function saveIntoLocal(){var e={};e.UserInfo=UserInfo,e.notebooks=transform(Notebook.cache),e.shareNotebooks=shareNotebooks,e.sharedUserInfos=sharedUserInfos,e.notes=transform(Note.cache),e.latestNotes=transform(Note.cache),e.tagsJson=clone(Tag.tags),e.shareNotebookDefault=shareNotebookDefault,e.trackingLog=trackingLog,e.group=group,localforage.setItem("allAppData",e,function(e,t){console.log("newAllAppData saved")})}function onbeforeunload_handler(){saveIntoLocal(),Server.uploadToServer();var e="Please confirm to leave Q-Note";return e}function clone(e){var t,o,a;if("object"!=typeof e||null===e)return e;if(e instanceof Array)for(t=[],o=0,a=e.length;a>o;o++)"object"==typeof e[o]&&null!=e[o]?t[o]=arguments.callee(e[o]):t[o]=e[o];else{t={};for(o in e)"object"==typeof e[o]&&null!=e[o]?t[o]=arguments.callee(e[o]):t[o]=e[o]}return t}function listGroupInfo(e){showGroupDialogRemote("",{})}function showNoteInfo(){$("#noteInfo").empty;var e=["<table>","<tr><th>"+getMsg("Create Time")+'</th><td id="noteInfoCreatedTime"></td></tr>',"<tr><th>"+getMsg("Update Time")+'</th><td id="noteInfoUpdatedTime"></td></tr>','<tr class="post-url-tr">',"<th>"+getMsg("Post Url")+"</th>","<td>",'<div class="post-url-wrap">','<span class="post-url-base">http://blog.leanote.com/life/post/</span><span><span class="post-url-text">life-life-life-a-leanote</span>','<input type="text" class="form-control">',"</span>",' <a class="post-url-pencil" title="'+getMsg("update")+'"><i class="fa fa-pencil"></i></a>',"</div>","</td>","</tr>","</table>"].join("");$("#groupInfoTable").append(e)}var normUrl=baseUrl+basePort+"/",Server={};if(Server.transfer=function(e){var t=JSON.stringify(e),o=normUrl+"updateAll";$.ajax({type:"POST",url:o,data:t,contentType:"text/plain",success:function(e){var t=jQuery.parseJSON(e);showMsg("success"==t.status?getMsg(t.msg):getMsg(t.msg))},error:function(e,t,o){showMsg(getMsg(o))}})},Server.uploadToServer=function(){var e={};e.UserInfo=UserInfo,e.notebooks=transform(Notebook.cache),e.shareNotebooks=shareNotebooks,e.sharedUserInfos=sharedUserInfos,e.notes=transform(Note.cache),e.latestNotes=transform(Note.cache),e.tagsJson=clone(Tag.tags),e.trackingLog=trackingLog,e.shareNotebookDefault=shareNotebookDefault,e.group=group,Server.transfer(e)},"undefined"==typeof LEA)var LEA={};var Notebook={cache:{}},Note={cache:{}},Tag={},Notebook={},Share={},Mobile={},LeaAce={},Converter,MarkdownEditor,ScrollLink,MD;$.extend(LEA,{_eventCallbacks:{},_listen:function(e,t){var o=this._eventCallbacks[e]||(this._eventCallbacks[e]=[]);o.push(t)},on:function(e,t){for(var o=e.split(/\s+/),a=0;a<o.length;++a)this._listen(o[a],t);return this},off:function(e,t){var o,a,n,r,i=e.split(/\s+/);for(o=0;o<i.length;o++)if(n=this._eventCallbacks[i[o].toLowerCase()]){for(r=null,a=0;a<n.length;a++)n[a]==t&&(r=a);null!==r&&n.splice(r,1)}},trigger:function(e,t){var o=this._eventCallbacks[e]||[];if(0!==o.length)for(var a=0;a<o.length;a++)o[a].call(this,t)}});var tt=t,previewToken="<div style='display: none'>FORTOKEN</div>",clearIntervalForSetContent;$(function(){$.pnotify&&($.pnotify.defaults.delay=1e3)}),Date.prototype.format=function(e){var t={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(e)&&(e=e.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var o in t)new RegExp("("+o+")").test(e)&&(e=e.replace(RegExp.$1,1==RegExp.$1.length?t[o]:("00"+t[o]).substr((""+t[o]).length)));return e};var email2LoginAddress={"qq.com":"http://mail.qq.com","gmail.com":"http://mail.google.com","sina.com":"http://mail.sina.com.cn","163.com":"http://mail.163.com","126.com":"http://mail.126.com","yeah.net":"http://www.yeah.net/","sohu.com":"http://mail.sohu.com/","tom.com":"http://mail.tom.com/","sogou.com":"http://mail.sogou.com/","139.com":"http://mail.10086.cn/","hotmail.com":"http://www.hotmail.com","live.com":"http://login.live.com/","live.cn":"http://login.live.cn/","live.com.cn":"http://login.live.com.cn","189.com":"http://webmail16.189.cn/webmail/","yahoo.com.cn":"http://mail.cn.yahoo.com/","yahoo.cn":"http://mail.cn.yahoo.com/","eyou.com":"http://www.eyou.com/","21cn.com":"http://mail.21cn.com/","188.com":"http://www.188.com/","foxmail.com":"http://mail.foxmail.com"},vd={isInt:function(e){var t=/^0$|^[1-9]\d*$/;return result=t.test(e),result},isNumeric:function(e){return $.isNumeric(e)},isFloat:function(e){var t=/^0(\.\d+)?$|^[1-9]\d*(\.\d+)?$/;return result=t.test(e),result},isEmail:function(e){var t=/^([a-zA-Z0-9]+[_|\_|\.|\-]?)*[a-zA-Z0-9\-]+@([a-zA-Z0-9\-]+[_|\_|\.|\-]?)*[a-zA-Z0-9\-]+\.[0-9a-zA-Z]{2,3}$/;return result=t.test(e),result},isBlank:function(e){return!$.trim(e)},has_special_chars:function(e){return/['"#$%&\^<>\?*]/.test(e)},init:function(form,rule_funcs){function is_required(e){var t=get_name(e),o=get_rules(e,t),a=o[0];return"required"==a.rule?!0:!1}function get_rules(target,name){return rules[name]||(rules[name]=eval("("+target.data("rules")+")")),rules[name]}function get_msg_target(e,t){if(!msg_targets[t]){var o=e.data("msg_target");if(o)msg_targets[t]=$(o);else{var a=$('<div class="help-block alert alert-warning" style="display: block;"></div>');e.parent().append(a),msg_targets[t]=a}}return msg_targets[t]}function hide_msg(e,t){var o=get_msg_target(e,t);o.hasClass("alert-success")||o.hide()}function show_msg(e,t,o,a){var n=get_msg_target(e,t);n.html(getMsg(o,a)).removeClass("hide alert-success").addClass("alert-danger").show()}function pre_fix(e){var t=e.data("pre_fix");if(t)switch(t){case"int":int_fix(e);break;case"price":price_fix(e);break;case"decimal":decimal_fix(e)}}function apply_rules(e,t){var o=get_rules(e,t);if(pre_fix(e),!o)return!0;for(var a=0;a<o.length;++a){var n=o[a],r=n.rule,i=n.msg,s=n.msgData;if(!rule_funcs[r](e,n))return show_msg(e,t,i,s),!1}hide_msg(e,t);var l=e.data("post_rule");return l&&setTimeout(function(){var e=$(l);apply_rules(e,get_name(e))},0),!0}function focus_func(e){var t=$(e.target),o=get_name(t);hide_msg(t,o),pre_fix(t)}function unfocus_func(e){var t=$(e.target),o=get_name(t);apply_rules(t,o)}function get_name(e){return e.data("u_name")||e.attr("name")||e.attr("id")}var get_val=function(e){if(e.is(":checkbox")){var t=e.attr("name"),o=$('input[name="'+t+'"]:checked').length;return o}return e.is(":radio")?void 0:e.val()},default_rule_funcs={required:function(e){return get_val(e)},min:function(e,t){var o=get_val(e);return(""!==o||is_required(e))&&o<t.data?!1:!0},minLength:function(e,t){var o=get_val(e);return(""!==o||is_required(e))&&o.length<t.data?!1:!0},email:function(e,t){var o=get_val(e);return""!==o||is_required(e)?vd.isEmail(o):!0},noSpecialChars:function(e){var t=get_val(e);return t&&/[^0-9a-zzA-Z_\-]/.test(t)?!1:!0},password:function(e,t){var o=get_val(e);return""!==o||is_required(e)?o.length>=6:!0},equalTo:function(e,t){var o=get_val(e);return""!==o||is_required(e)?$(t.data).val()==o:!0}};rule_funcs=rule_funcs||{},rule_funcs=$.extend(default_rule_funcs,rule_funcs);var rules={},msg_targets={},$allElems=$(form).find("[data-rules]"),$form=$(form);$form.on({keyup:function(e){13!=e.keyCode&&focus_func(e)},blur:unfocus_func},'input[type="text"], input[type="password"]'),$form.on({change:function(e){$(this).val()?focus_func(e):unfocus_func(e)}},"select"),$form.on({change:function(e){unfocus_func(e)}},'input[type="checkbox"]'),this.valid=function(){for(var e=$allElems,t=!0,o=0;o<e.length;++o){var a=e.eq(o),n=get_name(a);if(!apply_rules(a,n))return t=!1,a.focus(),!1}return t},this.validElement=function(e){for(var e=$(e),t=!0,o=0;o<e.length;++o){var a=e.eq(o),n=get_name(a);apply_rules(a,n)||(t=!1)}return t}}},trimTitle=function(e){return e&&"string"==typeof e?e.replace(/</g,"&lt;").replace(/>/g,"&gt;"):""};Note.curNoteId="",Note.interval="",Note.itemIsBlog='<div class="item-blog"><i class="fa fa-bold" title="blog"></i></div><div class="item-setting"><i class="fa fa-cog" title="setting"></i></div>',Note.itemTplNoImg='<li href="#" class="item ?" data-seq="?" noteId="?">',Note.itemTplNoImg+=Note.itemIsBlog+'<div class="item-desc"><p class="item-title">?</p ><p class="item-info"><i class="fa fa-book"></i> <span class="note-notebook">?</span></p ></div></li>',Note.itemTpl='<li href="#" class="item ?" data-seq="?" noteId="?">',Note.itemTpl+=Note.itemIsBlog+'<div class="item-desc" style=""><p class="item-title">?</p ><p class="item-info"><i class="fa fa-book"></i> <span class="note-notebook">?</span> </p ><p class="desc">?</p ></div></li>',Note.newItemTpl='<li href="#" class="item item-active ?" data-seq="?" fromUserId="?" noteId="?">',Note.newItemTpl+=Note.itemIsBlog+'<div class="item-desc" style="right: 0px;"><p class="item-title">?</p ><p class="item-info"><i class="fa fa-book"></i> <span class="note-notebook">?</span> </p ><p class="desc">?</p ></div></li>',Note.noteItemListO=$("#noteItemList"),Note.cacheByNotebookId={all:{}},Note.notebookIds={},Note.isReadOnly=!1,Note.intervalTime=1e4,Note.startInterval=function(){clearInterval(Note.interval),Note.interval=setInterval(function(){log("automatically saving starts..."),Note.curChangedSaveIt()},Note.intervalTime)},Note.stopInterval=function(){clearInterval(Note.interval),setTimeout(function(){Note.startInterval()},Note.intervalTime)},Note.addNoteCache=function(e){Note.cache[e.NoteId]=e,Note.clearCacheByNotebookId(e.NotebookId)},Note.setNoteCache=function(e,t){void 0!=e.NoteId&&(Note.cache[e.NoteId]?$.extend(Note.cache[e.NoteId],e):Note.cache[e.NoteId]=e,void 0==t&&(t=!0),t&&Note.clearCacheByNotebookId(e.NotebookId))},Note.setCurNoteId=function(e){this.curNoteId=e},Note.clearCurNoteId=function(){this.curNoteId=null},Note.getCurNote=function(){var e=this;return""==e.curNoteId?null:e.cache[e.curNoteId]},Note.getNote=function(e){var t=this;return t.cache[e]},Note.clearCacheByNotebookId=function(e){e&&(Note.cacheByNotebookId[e]={},Note.cacheByNotebookId.all={},Note.notebookIds[e]=!0)},Note.notebookHasNotes=function(e){var t=Note.getNotesByNotebookId(e);return!isEmpty(t)},Note.getNotesByNotebookId=function(e,t,o){if(t||(t="UpdatedTime"),"undefined"==o&&(o=!1),e||(e="all"),!Note.cacheByNotebookId[e])return[];if(Note.cacheByNotebookId[e][t])return Note.cacheByNotebookId[e][t];var a=[];for(var n in Note.cache)if(n){var r=Note.cache[n];r.IsTrash||r.IsShared||("all"==e||r.NotebookId==e)&&a.push(r)}return a.sort(function(e,a){var n=e[t],r=a[t];if(o){if(r>n)return-1;if(n>r)return 1}else{if(r>n)return 1;if(n>r)return-1}return 0}),Note.cacheByNotebookId[e][t]=a,a},Note.renderNotesAndFirstOneContent=function(e){isArray(e)&&(Note.renderNotes(e),isEmpty(e[0])||Note.changeNoteForPjax(e[0].NoteId,!0,!1))},Note.curHasChanged=function(e){var t=Note.getCurNote();if(!t)return!1;var o=$("#noteTitle").val(),a=Tag.getTags(),n={hasChanged:!1,IsNew:t.IsNew,IsMarkdown:t.IsMarkdown,FromUserId:t.FromUserId,NoteId:t.NoteId,NotebookId:t.NotebookId};t.IsNew&&(n.hasChanged=!0),t.Title!=o&&(n.hasChanged=!0,n.Title=o),arrayEqual(t.Tags,a)||(n.hasChanged=!0,n.Tags=a.join(","));var r=!1;if((t.IsNew||e||!Note.readOnly)&&(r=!0),!n.hasChanged&&!r)return!1;if(!r)return n;var i,s,l=getEditorContent(t.IsMarkdown);if(isArray(l)?(i=l[0],s=l[1],i&&previewIsEmpty(s)&&Converter&&(s=Converter.makeHtml(i)),i||(s=""),t.Preview=s):i=l,t.Content!=i){n.hasChanged=!0,n.Content=i;var c=s||i;t.HasSelfDefined&&t.IsBlog||(n.Desc=Note.genDesc(c),n.ImgSrc=Note.getImgSrc(c),n.Abstract=Note.genAbstract(c))}else log("text相同");return n.hasChanged?n:!1},Note.genDesc=function(e){return e?(e=e.replace(/<br \/>/g," "),e=e.replace(/<\/p>/g," "),e=e.replace(/<\/div>/g," "),e=e.replace(/<\/?[^>]+(>|$)/g,""),e=$.trim(e),e=e.replace(/</g,"&lt;"),e=e.replace(/>/g,"&gt;"),e.length<300?e:e.substring(0,300)):""},Note.genAbstract=function(e,t){if(!e)return"";if(void 0==t&&(t=1e3),e.length<t)return e;for(var o=!1,a=!1,n=0,r="",i=t,s=0;s<e.length;++s){var l=e[s];if("<"==l?o=!0:"&"==l?a=!0:">"==l&&o?(n-=1,o=!1):";"==l&&a&&(a=!1),o||a||(n+=1),r+=l,n>=i)break}var c=document.createElement("div");return c.innerHTML=r,c.innerHTML},Note.getImgSrc=function(e){if(!e)return"";var t=$(e).find("img");for(var o in t){var a=t.eq(o).attr("src");if(a)return a}return""},Note.saveInProcess={},Note.savePool={},Note.curChangedSaveIt=function(e,t){var o=this;if(Note.curNoteId){var a;try{a=Note.curHasChanged(e)}catch(n){return void(t&&t(!1))}return a&&a.hasChanged?(Note.renderChangedNote(a),delete a.hasChanged,showMsg("Locally saving"),setTimeout(function(){showMsg("Locally saved")},500),o.saveInProcess[a.NoteId]=!0,void 0!=a.Tags&&"string"==typeof a.Tags&&(a.Tags=a.Tags.split(",")),Note.setNoteCache(a,!1),Note.setNoteCache({NoteId:a.NoteId,UpdatedTime:getCurDate()},!1),a):(log("无需保存"),!1)}},Note.updatePoolNote=function(){var e=this;for(var t in e.savePool)if(t){delete e.savePool[t];var o=e.savePool[t];e.saveInProcess[t]=!0,ajaxPost("/note/updateNoteOrContent",o,function(o){e.saveInProcess[t]=!1})}},Note.updatePoolNoteInterval=null,Note.startUpdatePoolNoteInterval=function(){},Note.clearSelect=function(e){$(".item").removeClass("item-active")},Note.selectTarget=function(e){this.clearSelect(),$(e).addClass("item-active")},Note.showContentLoading=function(){$("#noteMaskForLoading").css("z-index",11)},Note.hideContentLoading=function(){$("#noteMaskForLoading").css("z-index",-1)},Note.directToNote=function(e){var t=$("#noteItemList"),o=t.height(),a=$("[noteId='"+e+"']").position().top,n=t.scrollTop();if(a+=n,a>=n&&o+n>=a);else{log("定位到特定note, 在可视范围内")}},Note.changeNoteForPjax=function(e,t,o){var a=this,n=a.getNote(e);if(n||(n=Share.getNote(e)),n){var r=void 0!=n.Perm;void 0==o&&(o=!0),a.changeNote(e,r,!0,function(a){void 0==t&&(t=!0),t&&Pjax.changeNote(a),o&&Note.directToNote(e)}),o&&(r?$("#myShareNotebooks").hasClass("closed")&&$("#myShareNotebooks .folderHeader").trigger("click"):$("#myNotebooks").hasClass("closed")&&$("#myNotebooks .folderHeader").trigger("click"),Notebook.expandNotebookTo(n.NotebookId))}},Note.contentAjax=null,Note.contentAjaxSeq=1,Note.changeNote=function(e,t,o,a){var n=this;if(e){Note.stopInterval();var r=n.getTargetById(e);Note.selectTarget(r),void 0==o&&(o=!0),o&&Note.curChangedSaveIt(!0),Note.clearCurNoteId();var i=n.getNote(e)||Share.getNote(e);if(i){t||void 0!=i.Perm&&(t=!0);var s=!t||Share.hasUpdatePerm(e);s?Note.renderNote(i):Note.renderNoteReadOnly(i),switchEditor(i.IsMarkdown),n.showContentLoading(),t=Note.cache[e]||Share.getNote(e),Note.renderNoteContent(t),n.hideContentLoading()}}},Note.renderChangedNote=function(e){if(e){var t=$(tt('[noteId="?"]',e.NoteId));e.Title&&t.find(".item-title").html(trimTitle(e.Title)),e.Desc&&t.find(".desc").html(trimTitle(e.Desc))}},Note.clearNoteInfo=function(){Note.clearCurNoteId(),Tag.clearTags(),$("#noteTitle").val(""),setEditorContent("")},Note.clearNoteList=function(){Note.noteItemListO.html("")},Note.clearAll=function(){Note.clearCurNoteId(),Note.clearNoteInfo(),Note.clearNoteList()},Note.renderNote=function(e){e&&($("#noteTitle").val(e.Title),Tag.renderTags(e.Tags))},Note.renderNoteContent=function(e){setEditorContent(e.Content,e.IsMarkdown,e.Preview,function(){Note.setCurNoteId(e.NoteId)})},Note.showEditorMask=function(){$("#noteList").attr("style","visibility: hidden"),$("#tool").attr("style","visibility: hidden"),$("#noteTitleDiv").attr("style","visibility: hidden"),$("#editorMask").css("z-index",10).show(),Notebook.curNotebookIsTrashOrAll()?($("#editorMaskBtns").hide(),$("#editorMaskBtnsEmpty").show()):($("#editorMaskBtns").show(),$("#editorMaskBtnsEmpty").hide())},Note.hideEditorMask=function(){$("#noteList").attr("style","visibility: visible"),$("#tool").attr("style","visibility: visible"),$("#noteTitleDiv").attr("style","visibility: visible"),$("#editorMask").css("z-index",-10).hide()},Note.renderNotesC=0,Note.renderNotes=function(e,t,o){var a=++Note.renderNotesC;if(this.clearSeqForNew(),this.batch.reset(),LEA.isMobile||Mobile.isMobile()||$("#noteItemList").slimScroll({scrollTo:"0px",height:"100%",onlyScrollBar:!0}),!e||"object"!=typeof e||e.length<=0)return void(t||Note.showEditorMask());Note.hideEditorMask(),void 0==t&&(t=!1),t||Note.noteItemListO.html("");var n=e.length,r=Math.ceil(n/20);Note._renderNotes(e,t,o,1);for(var i=0;n>i;++i){var s=e[i];o?Share.setCache(s):Note.setNoteCache(s,!1)}for(var i=1;r>i;++i)setTimeout(function(n){return function(){a==Note.renderNotesC&&Note._renderNotes(e,t,o,n+1)}}(i),2e3*i)},Note._renderNotes=function(e,t,o,a){for(var n=e.length,r=20*(a-1);n>r&&20*a>r;++r){var i=e[r];i.Title=trimTitle(i.Title);var s="item-my";Note.nowIsInShared=!1,(o||i.UserId!=UserInfo.UserId)&&(s="item-shared",Note.nowIsInShared=!0),t||0!=r||(s+=" item-active");var l;l=tt(Note.itemTplNoImg,s,r,i.NoteId,i.Title,Notebook.getNotebookTitle(i.NotebookId)),i.IsBlog||(l=$(l),l.find(".item-blog").hide()),Note.noteItemListO.append(l)}},Note._seqForNew=0,Note.clearSeqForNew=function(){this._seqForNew=0},Note.newNoteSeq=function(){return--this._seqForNew},Note.newNote=function(e,t,o,a){if(Object.getOwnPropertyNames(Notebook.cache).length<=2)return void bootbox.alert("Sorry, please create a notebook first",function(){});Note.hideEditorMask(),Note.stopInterval(),Note.curChangedSaveIt(!0),Note.batch.reset();var n={NoteId:getObjectId(),Title:"",Tags:[],Content:"",NotebookId:e,IsNew:!0,IsTrash:!1,IsDeleted:!1,Desc:"",IsTop:!0,FromUserId:o,IsMarkdown:a,AttachNum:0,CommentNum:0,CreatedTime:getCurDate(),CreatedUserId:"",HasSelfDefined:!1,IsBlog:!1,IsRecommend:!1,LikeNum:0,ReadNum:0,RecommendTime:"0001-01-01T00:00:00Z",UpdatedUserId:"",UrlTitle:"",UserId:UserInfo.UserId};Note.addNoteCache(n);var r="",i="item-my";t&&(i="item-shared");var s=Notebook.getNotebook(e),l=s?s.Title:"";r=t?tt(Note.newItemTpl,i,this.newNoteSeq(),o,n.NoteId,n.Title,l,""):tt(Note.newItemTpl,i,this.newNoteSeq(),"",n.NoteId,n.Title,l,""),s.IsBlog||(r=$(r),r.find(".item-blog").hide()),Notebook.isCurNotebook(e)?Note.noteItemListO.prepend(r):(Note.clearAll(),
Note.noteItemListO.prepend(r),t?Share.changeNotebookForNewNote(e):Notebook.changeNotebookForNewNote(e)),Note.selectTarget($(tt('[noteId="?"]',n.NoteId))),$("#noteTitle").focus(),Note.renderNote(n),Note.renderNoteContent(n),Note.setCurNoteId(n.NoteId),Notebook.incrNotebookNumberNotes(e),showMsg("New note created")},Note.changeToNext=function(e){var t=$(e),o=t.next();if(!o.length){var a=t.prev();if(!a.length)return void Note.showEditorMask();o=a}Note.changeNote(o.attr("noteId"))},Note.changeToNextSkipNotes=function(e){var t=Note;if(!isEmpty(e)){if(t.$itemList.find("li").length==e.length)return void t.showEditorMask();if(1==e.length){var o=t.$itemList.find(".item-active");if(1==o.length&&o.attr("noteId")!=e[0])return}for(var a=t.getTargetById(e[0]),n=a.next(),r=1,i=e.length,s=!1;n.length;){if(r>=i){s=!0;break}if(n.attr("noteId")!=t.getTargetById(e[r]).attr("noteId")){s=!0;break}n=n.next(),r++}s||(n=a.prev()),n&&t.changeNote(n.attr("noteId"))}},Note.deleteNote=function(e,t,o){var a=Note,n=a.inBatch?a.getBatchNoteIds():[$(e).attr("noteId")];if(!isEmpty(n)){var r=Note.cache[n],i=r.Title;"-1"==Notebook.curNotebookId||"0"==Notebook.curNotebookId&&"-1"==r.NotebookId?bootbox.confirm("Please confirm to forever delete the note: "+i,function(t){if(t){1==n.length&&$(e).hasClass("item-active")&&(Note.stopInterval(),a.clearCurNoteId(),Note.clearNoteInfo());var o;o=1==n.length?$(e):a.$itemList.find(".item-active"),o.hide(),Note.changeToNextSkipNotes(n),o.remove();for(var r=0;r<n.length;++r){var s=n[r],l=a.getNote(s);l&&(Notebook.minusNotebookNumberNotes(l.NotebookId),Note.clearCacheByNotebookId(l.NotebookId),delete Note.cache[s])}showMsg("Note "+i+" deleted successfully")}}):(Note.moveNoteWithId(n,-1),showMsg("Note moved to trash"))}},Note.listNoteShareUserInfo=function(e){var t=$(e).attr("noteId");Share.dialogIsNote=1,Share.dialogNoteOrNotebookId=t,showDialogRemote("/share/listNoteShareUserInfo",{noteId:t})},Note.shareNote=function(e){var t=$(e).find(".item-title").text();showDialog("dialogShareNote",{title:getMsg("shareToFriends")+"-"+t}),setTimeout(function(){$("#friendsEmail").focus()},500);var o=$(e).attr("noteId");shareNoteOrNotebook(o,!0)},Note.download=function(e,t){var o="";for(var a in t)o+='<input name="'+a+'" value="'+t[a]+'">';$('<form target="mdImageManager" action="'+e+'" method="GET">'+o+"</form>").appendTo("body").submit().remove()},Note.exportPDF=function(e){var t=$(e).attr("noteId");$('<form target="mdImageManager" action="/note/exportPdf" method="GET"><input name="noteId" value="'+t+'"/></form>').appendTo("body").submit().remove()},Note.renderNoteReadOnly=function(e){$("#noteReadTitle").html(e.Title||getMsg("unTitled")),Tag.renderReadOnlyTags(e.Tags),$("#noteReadCreatedTime").html(goNowToDatetime(e.CreatedTime)),$("#noteReadUpdatedTime").html(goNowToDatetime(e.UpdatedTime))},Note.lastSearch=null,Note.lastKey=null,Note.lastSearchTime=new Date,Note.isOver2Seconds=!1,Note.isSameSearch=function(e){var t=new Date,o=t.getTime()-Note.lastSearchTime.getTime();return Note.isOver2Seconds=o>2e3?!0:!1,!Note.lastKey||Note.lastKey!=e||o>1e3?(Note.lastKey=e,Note.lastSearchTime=t,!1):e==Note.lastKey?!0:(Note.lastSearchTime=t,Note.lastKey=e,!1)},Note.searchNote=function(){var e=$("#searchNoteInput").val();return e?void(Note.isSameSearch(e)||(Note.lastSearch&&Note.lastSearch.abort(),Note.curChangedSaveIt(),Note.clearAll(),showLoading(),Notebook.showNoteAndEditorLoading(),Note.lastSearch=$.post("/note/searchNote",{key:e},function(e){hideLoading(),Notebook.hideNoteAndEditorLoading(),e&&(Note.lastSearch=null,Note.renderNotes(e),isEmpty(e)||Note.changeNote(e[0].NoteId,!1))}))):void Notebook.changeNotebook("0")},Note.$itemList=$("#noteItemList"),Note.getTargetById=function(e){return this.$itemList.find('li[noteId="'+e+'"]')},Note.moveNote=function(e,t){var o,a=Note;o=Note.inBatch?a.getBatchNoteIds():[$(e).attr("noteId")];var n=t.notebookId;if(Notebook.getCurNotebookId()!=n){if(1==o.length){var r=a.getNote(o[0]);if(!r.IsTrash&&r.NotebookId==n)return}console.log(o),a.clearCacheByNotebookId(n);for(var r=0;r<o.length;++r){var i=o[r],s=a.getNote(i);s&&(s.NotebookId!=n?(Notebook.incrNotebookNumberNotes(n),s.IsTrash||Notebook.minusNotebookNumberNotes(s.NotebookId),console.log("first")):s.IsTrash&&Notebook.incrNotebookNumberNotes(s.NotebookId),a.clearCacheByNotebookId(s.NotebookId),s.NotebookId=n,s.IsTrash=!1,s.UpdatedTime=new Date,a.setNoteCache(s),console.log("second"))}var l;l=1==o.length?e:a.$itemList.find(".item-active"),Notebook.curActiveNotebookIsAll()?(l.find(".note-notebook").html(Notebook.getNotebookTitle(n)),a.changeNote(l.eq(0).attr("noteId"))):(a.changeToNextSkipNotes(o),l.remove())}},Note.moveNoteWithId=function(e,o){var a=Note;if(Notebook.getCurNotebookId()!=o){if(1==e.length){var n=a.getNote(e[0]);if(!n.IsTrash&&n.NotebookId==o)return}a.clearCacheByNotebookId(o);for(var n=0;n<e.length;++n){var r=e[n],i=a.getNote(r);i&&(i.NotebookId!=o?(Notebook.incrNotebookNumberNotes(o),i.IsTrash||Notebook.minusNotebookNumberNotes(i.NotebookId)):i.IsTrash&&Notebook.incrNotebookNumberNotes(i.NotebookId),a.clearCacheByNotebookId(i.NotebookId),i.NotebookId=o,i.IsTrash=!1,i.UpdatedTime=new Date,a.setNoteCache(i))}var s;s=1==e.length?t:a.$itemList.find(".item-active"),Notebook.curActiveNotebookIsAll()?(s.find(".note-notebook").html(Notebook.getNotebookTitle(o)),a.changeNote(s.eq(0).attr("noteId"))):(a.changeToNextSkipNotes(e),s.remove())}},Note.copyNote=function(e,t,o){var a,n=Note,r=t.notebookId;a=Note.inBatch?n.getBatchNoteIds():[$(e).attr("noteId")];for(var i=[],s=0;s<a.length;++s){var l=a[s],c=n.getNote(l);if(c){if(c.IsTrash||c.NotebookId==r)continue;i.push(l)}}Note.clearCacheByNotebookId(r);var d=Note.getNote(i),s=clone(d);Notebook.incrNotebookNumberNotes(r),Note.clearCacheByNotebookId(s.NotebookId),s.NotebookId=r,s.IsTrash=!1,s.UpdatedTime=getCurDate(),s.NoteId=getObjectId(),Note.setNoteCache(s)},Note.deleteNoteTag=function(e){for(var t in Note.cache){var o=Note.getNote(t);if(o){o.Tags=o.Tags||[];for(var a in o.Tags)o.Tags[a]==e&&o.Tags.splice(a,1);t==Note.curNoteId&&Tag.renderTags(o.Tags)}}Tag.tags},Note.getPostUrl=function(e){var t=e.UrlTitle||e.NoteId;return UserInfo.PostUrl+"/"+t},Note.getContextNotebooks=function(e){var t=[],o=[],a=[];for(var n in e){var r=e[n],i={text:r.Title,notebookId:r.NotebookId,action:Note.moveNote},s={text:r.Title,notebookId:r.NotebookId,action:Note.copyNote},l={text:r.Title,notebookId:r.NotebookId,action:Share.copySharedNote};if(!isEmpty(r.Subs)){var c=Note.getContextNotebooks(r.Subs);i.items=c[0],s.items=c[1],l.items=c[2],i.type="group",i.width=150,s.type="group",s.width=150,l.type="group",l.width=150}t.push(i),o.push(s),a.push(l)}return[t,o,a]},Note.contextmenu=null,Note.notebooksCopy=[],Note.initContextmenu=function(){function e(e){var t=$(this).attr("noteId");if(o=[],Note.inBatch)o.push("shareToFriends"),o.push("exportPDF"),Notebook.curActiveNotebookIsTrash()&&(o.push("shareStatus"),o.push("copy"));else{var a=Note.getNote(t);if(!a)return;if(a.IsTrash||Notebook.curActiveNotebookIsTrash())o.push("shareToFriends"),o.push("shareStatus"),o.push("copy");else{var n=Notebook.getNotebookTitle(a.NotebookId);o.push("move."+n),o.push("copy."+n)}}e.applyrule({name:"target..",disable:!0,items:o})}function t(){return"target3"!=this.id}var o=Note;Note.contextmenu&&Note.contextmenu.destroy();var a=Notebook.everNotebooks,n=o.getContextNotebooks(a),r=n[0],i=n[1];o.notebooksCopy=n[2];var s={width:180,items:[{text:getMsg("shareToFriends"),alias:"shareToFriends",icon:"",faIcon:"fa-share-square-o",action:Note.listNoteShareUserInfo},{type:"splitLine"},{text:"information",alias:"information",faIcon:"fa-file-pdf-o",action:Note.getInformation},{text:getMsg("exportPdf"),alias:"exportPDF",faIcon:"fa-file-pdf-o",action:Note.exportPDF},{type:"splitLine"},{text:getMsg("delete"),icon:"",faIcon:"fa-trash-o",action:Note.deleteNote},{text:getMsg("move"),alias:"move",faIcon:"fa-arrow-right",type:"group",width:180,items:r},{text:getMsg("copy"),alias:"copy",icon:"",faIcon:"fa-copy",type:"group",width:180,items:i}],onShow:e,onContextMenu:t,parent:"#noteItemList",children:".item-my"};Note.contextmenu=$("#noteItemList .item-my").contextmenu(s)};var Attach={loadedNoteAttachs:{},attachsMap:{},init:function(){var e=this;$("#showAttach").click(function(){e.renderAttachs(Note.curNoteId)}),e.attachListO.click(function(e){e.stopPropagation()}),e.attachListO.on("click",".delete-attach",function(t){t.stopPropagation();var o=$(this).closest("li").data("id"),a=this;confirm(getMsg("Are you sure to delete it ?"))&&($(a).button("loading"),ajaxPost("/attach/deleteAttach",{attachId:o},function(t){$(a).button("reset"),reIsOk(t)?e.deleteAttach(o):alert(t.Msg)}))}),e.attachListO.on("click",".download-attach",function(e){e.stopPropagation();var t=$(this).closest("li").data("id");Note.download("/attach/download",{attachId:t})}),e.downloadAllBtnO.click(function(){Note.download("/attach/downloadAll",{noteId:Note.curNoteId})}),e.attachListO.on("click",".link-attach",function(t){t.stopPropagation();var o=$(this).closest("li").data("id"),a=e.attachsMap[o],n=UrlPrefix+"/api/file/getAttach?fileId="+o;LEA.isMarkdownEditor()&&MD?MD.insertLink(n,a.Title):tinymce.activeEditor.insertContent('<a target="_blank" href="'+n+'">'+a.Title+"</a>")})},attachListO:$("#attachList"),attachNumO:$("#attachNum"),attachDropdownO:$("#attachDropdown"),downloadAllBtnO:$("#downloadAllBtn"),linkAllBtnO:$("#linkAllBtn"),clearNoteAttachNum:function(){var e=this;e.attachNumO.html("").hide()},renderNoteAttachNum:function(e,t){var o=this,a=Note.getNote(e);a.AttachNum?(o.attachNumO.html("("+a.AttachNum+")").show(),o.downloadAllBtnO.show(),o.linkAllBtnO.show()):(o.attachNumO.hide(),o.downloadAllBtnO.hide(),o.linkAllBtnO.hide()),t&&o.attachDropdownO.removeClass("open")},_renderAttachs:function(e){for(var t=this,o="",a=e.length,n=getMsg("Delete"),r=getMsg("Download"),i=getMsg("Insert link into content"),s=0;a>s;++s){var l=e[s];o+='<li class="clearfix" data-id="'+l.AttachId+'"><div class="attach-title">'+l.Title+'</div><div class="attach-process"> 	  <button class="btn btn-sm btn-warning delete-attach" data-loading-text="..." title="'+n+'"><i class="fa fa-trash-o"></i></button> 	  <button type="button" class="btn btn-sm btn-primary download-attach" title="'+r+'"><i class="fa fa-download"></i></button> 	  <button type="button" class="btn btn-sm btn-default link-attach" title="'+i+'"><i class="fa fa-link"></i></button> </div></li>',t.attachsMap[l.AttachId]=l}t.attachListO.html(o);var c=Note.getCurNote();c&&(c.AttachNum=a,t.renderNoteAttachNum(c.NoteId,!1))},_bookmark:null,renderAttachs:function(e){var t=this;return t.loadedNoteAttachs[e]?void t._renderAttachs(t.loadedNoteAttachs[e]):(t.attachListO.html('<li class="loading"><img src="/images/loading-24.gif"/></li>'),void ajaxGet("/attach/getAttachs",{noteId:e},function(o){var a=[];o.Ok&&(a=o.List,a||(a=[])),t.loadedNoteAttachs[e]=a,t._renderAttachs(a)}))},addAttach:function(e){var t=this;t.loadedNoteAttachs[e.NoteId]||(t.loadedNoteAttachs[e.NoteId]=[]),t.loadedNoteAttachs[e.NoteId].push(e),t.renderAttachs(e.NoteId)},deleteAttach:function(e){for(var t=this,o=Note.curNoteId,a=t.loadedNoteAttachs[o],n=0;n<a.length;++n)if(a[n].AttachId==e){a.splice(n,1);break}t.renderAttachs(o)},downloadAttach:function(e){},downloadAll:function(){}};Note.inBatch=!1,Note.getBatchNoteIds=function(){for(var e=[],t=Note.$itemList.find(".item-active"),o=0;o<t.length;++o)e.push(t.eq(o).attr("noteId"));return e},Note.batch={$noteItemList:$("#noteItemList"),cancelInBatch:function(){Note.inBatch=!1,this.$body.removeClass("batch")},setInBatch:function(){Note.inBatch=!0,this.$body.addClass("batch")},isInBatch:function(){var e=this,t=e.$noteItemList.find(".item-active");return t.length>=2?!0:!1},_startNoteO:null,getStartNoteO:function(){var e=this;return e._startNoteO||(e._startNoteO=e.getCurSelected()),e._startNoteO},_selectByStart:{},clearByStart:function(e){var t=this;if(e){var o=this._selectByStart[e];if(!isEmpty(o))for(var a=0;a<o.length;++a)t.clearTarget(o[a])}},selectTo:function(e){var t=this.getStartNoteO();t||alert("nono start");var o,a,n,r,i=+t.data("seq"),s=+e.data("seq");s>i?(o=t,a=e,n=i,r=s):(o=e,a=t,n=s,r=i);var l=t.attr("noteId");this.clearByStart(l);var c=o;this._selectByStart[l]=[];for(var d=n;r>=d;++d)this.selectTarget(c),this._selectByStart[l].push(c),c=c.next()},selectAll:function(){this.$noteItemList.find("li").addClass("item-active")},clearAllSelect:function(){Note.clearSelect()},selectTarget:function(e){e&&e.addClass("item-active")},clearTarget:function(e){e&&e.removeClass("item-active")},select:function(e){var t=this;if(e.hasClass("item-active")){var o=this.isInBatch();o&&e.removeClass("item-active")}else t._startNoteO=e,this.selectTarget(e)},getCurSelected:function(){return this.$noteItemList.find(".item-active")},reset:function(){this.cancelInBatch(),this._selectByStart={},this._startMove=!1,this._startNoteO=null,this.clearRender()},canBatch:function(){return!1},init:function(){var e=this;e.$noteItemList.on("click",".item",function(t){var o=$(this);if(a=o.attr("noteId"),a){var n=!1,r=!1;e.canBatch()&&(t.shiftKey?r=!0:n=t.metaKey||t.ctrlKey),(n||r)&&Note.curChangedSaveIt(),n?e.select(o):r?e.selectTo(o):Note.selectTarget(o),e.finalFix()}}),e._startMove=!1,e.$noteItemList.on("mousedown",".item",function(t){e.canBatch()&&(e.isContextMenu(t)||(e._startMove||!(t.metaKey||t.ctrlKey||t.shiftKey))&&(e._startNoteO=$(this),e._startMove=!0))}),e.$noteItemList.on("mousemove",".item",function(t){e.canBatch()&&e._startMove&&(Note.curChangedSaveIt(),e.clearAllSelect(),e.selectTo($(this)),e.finalFix(!0))});var t=$("body");t.on("mouseup",function(){e._startMove=!1}),t.keydown(function(t){t.target&&"BODY"===t.target.nodeName&&(t.ctrlKey||t.metaKey)&&65===t.which&&(t.preventDefault(),e.canBatch()&&(Note.curChangedSaveIt(),e.selectAll(),e.finalFix()))}),e.$noteItemList.on("dragstart",function(e){e.preventDefault(),e.stopPropagation()}),e.initContextmenu()},initContextmenu:function(){var e=this;e.$batchMask.on("contextmenu",function(e){e.preventDefault(),Note.nowIsInShared?Share.contextmenu.showMenu(e):Note.contextmenu.showMenu(e)}),e.$batchMask.find(".batch-info .fa").click(function(e){e.preventDefault(),e.pageX-=90,e.pageY+=10,e.stopPropagation(),$(document).click(),Note.nowIsInShared?Share.contextmenu.showMenu(e):Note.contextmenu.showMenu(e)})},$body:$("body"),finalFix:function(e){var t=this;if(t.isInBatch())Note.clearCurNoteId(),t.renderBatchNotes(),t.setInBatch();else{t.clearRender(),t.cancelInBatch();var o=t.getCurSelected();if(o){var a=o.attr("noteId");e||(t._startNoteO=o),Mobile.changeNote(a),Note.curNoteId!=a&&Note.changeNoteForPjax(a,!0,!1)}}},isContextMenu:function(e){return void 0!=e.which&&1==e.which||1==e.button?!1:void 0!=e.which&&3==e.which||2==e.button?!0:!1},_notes:{},clearRender:function(){this._notes={},this.$batchCtn.html(""),this.hideMask()},showMask:function(){this.$batchMask.css({"z-index":99}).show()},hideMask:function(){this.$batchMask.css({"z-index":-2}).hide()},renderBatchNotes:function(){var e=this;e.showMask();var t=e.$noteItemList.find(".item-active");e.$batchNum.html(t.length);for(var o={},a=0;a<t.length;++a){var n=t.eq(a).attr("noteId");e.addTo(n),o[n]=1}for(var n in e._notes)if(!o[n]){var r=e._notes[n];r.css({"margin-left":"-800px"}),setTimeout(function(){r.remove()},500),delete e._notes[n]}},$batchMask:$("#batchMask"),$batchCtn:$("#batchCtn"),$batchNum:$("#batchMask .batch-info span"),_i:1,getRotate:function(){var e=this,t=e._i++,o=t%2===0?1:-1,a=(o*Math.random()*70,[0,10,20,30,40]),n=o*a[t%5]*3;return n-=80,[o*Math.random()*30,n]},addTo:function(e){var t=this;if(!t._notes[e]){var o=Note.getNote(e),a=o.Title||getMsg("unTitled"),n=o.Desc||"...",r=$('<div class="batch-note"><div class="title">'+a+'</div><div class="content">'+n+"</div></div>");t._notes[e]=r;var i=t.getRotate();t.$batchCtn.append(r),setTimeout(function(){r.css({transform:"rotate("+i[0]+"deg)","margin-left":i[1]+"px"})})}}},$(function(){Note.batch.init(),$("#newNoteBtn, #editorMask .note").click(function(){var e=$("#curNotebookForNewNote").attr("notebookId");Note.newNote(e)}),$("#notebookNavForNewNote").on("click","li div",function(){var e=$(this).attr("notebookId");$(this).hasClass("new-note-right")?Note.newNote(e,!1,"",!0):Note.newNote(e)}),$("#searchNotebookForAdd").click(function(e){e.stopPropagation()}),$("#searchNotebookForAdd").keyup(function(){var e=$(this).val();Notebook.searchNotebookForAddNote(e)}),$("#searchNotebookForList").keyup(function(){var e=$(this).val();Notebook.searchNotebookForList(e)}),$("#noteTitle").on("keydown",function(e){var t=e.keyCode||e.witch;9==t&&e.preventDefault()}),$("#searchNoteInput").on("keydown",function(e){var t=e.keyCode||e.witch;return 13==t||108==t?(e.preventDefault(),Note.searchNote(),!1):void 0}),$("#saveBtn").click(function(){Note.curChangedSaveIt(!0),saveIntoLocal()}),$("#synBtn").click(function(){Note.curChangedSaveIt(!0),Server.uploadToServer(),bootbox.alert("Synchronized successfully",function(){}),saveIntoLocal()}),$("#addBtn").click(function(){$("#editor").append('<div class = "drggableDiv" draggable=true contenteditable=true></div>'),addDDListeners()}),$("#infoDropdownBtn").click(function(){var e=Note.cache[Note.curNoteId].CreatedTime,t=Note.cache[Note.curNoteId].UpdatedTime;$("#noteInfo").empty();var o="<table><tr><th>"+getMsg("Create Time")+'</th><td id="noteInfoCreatedTime">'+e+"</td></tr><tr><th>"+getMsg("Update Time")+'</th><td id="noteInfoUpdatedTime">'+t+"</td></tr></table>";$("#noteInfo").append(o)}),Note.$itemList.on("click",".item-blog",function(e){e.preventDefault(),e.stopPropagation(),$(document).click();var t=$(this).parent().attr("noteId"),o=Note.getNote(t);o&&window.open(Note.getPostUrl(o))}),Note.$itemList.on("click",".item-my .item-setting",function(e){e.preventDefault(),e.stopPropagation(),$(document).click();var t=$(this).parent();Note.contextmenu.showMenu(e,t)}),$(".toolbar-update").click(function(){}),$("#editorContent").on("click","a",function(e){if(Note.readOnly){var t=$(this).attr("href");if(t&&"#"==t[0])return;e.preventDefault(),window.open(t)}}),$("#preview-contents").on("click","a",function(e){var t=$(this).attr("href");t&&"#"==t[0]||(e.preventDefault(),window.open(t))}),$(".shareLink").click(function(){$("#shareMsg").empty(),$("#shareMsg").removeClass("alert-danger"),$("#shareMsg").removeClass("alert-success")})}),Note.startInterval();var Resize={lineMove:!1,mdLineMove:!1,target:null,leftNotebook:$("#leftNotebook"),notebookSplitter:$("#notebookSplitter"),noteList:$("#noteList"),noteAndEditor:$("#noteAndEditor"),noteSplitter:$("#noteSplitter"),mediaSplitter:$("#mediaSplitter"),note:$("#note"),body:$("body"),media:$("#media"),leftColumn:$("#left-column"),rightColumn:$("#right-column"),mdSplitter:$("#mdSplitter2"),init:function(){var e=this;e.initEvent()},initEvent:function(){var e=this;$(".noteSplit").bind("mousedown",function(t){t.preventDefault(),e.lineMove=!0,$(this).css("background-color","#ccc"),e.target=$(this).attr("id"),$("#noteMask").css("z-index",99999)}),e.mdSplitter.bind("mousedown",function(t){t.preventDefault(),$(this).hasClass("open")&&(e.mdLineMove=!0)}),e.body.bind("mousemove",function(t){e.lineMove&&(t.preventDefault(),e.resize3Columns(t))}),e.body.bind("mouseup",function(t){e.stopResize(),$("#noteMask").css("z-index",-1)});var t;$(".layout-toggler-preview").click(function(){var o=$(this),a=e.leftColumn.parent();if(o.hasClass("open")){var n=a.width(),r=22,i=n-r;t=e.leftColumn.width(),e.leftColumn.width(i),e.rightColumn.css("left","auto").width(r),o.removeClass("open"),e.rightColumn.find(".layout-resizer").removeClass("open"),$(".preview-container").hide()}else o.addClass("open"),e.rightColumn.find(".layout-resizer").addClass("open"),e.leftColumn.width(t),$(".preview-container").show(),e.rightColumn.css("left",t).width("auto"),MD&&MD.onResize()})},stopResize:function(){var e=this;(e.lineMove||e.mdLineMove)&&ajaxGet("/user/updateColumnWidth",{mdEditorWidth:UserInfo.MdEditorWidth,notebookWidth:UserInfo.NotebookWidth,noteListWidth:UserInfo.NoteListWidth,MediaWidth:UserInfo.MediaWidth},function(){}),e.lineMove=!1,e.mdLineMove=!1,$(".noteSplit").css("background","none"),e.mdSplitter.css("background","none")},set3ColumnsWidth:function(e,t){var o=this;if(!(150>e||100>t||e>200||t>150)){var a=o.body.width()-e-t;400>a||(o.leftNotebook.width(e),o.notebookSplitter.css("left",e),o.noteAndEditor.css("left",e),o.noteList.width(t),o.noteSplitter.css("left",t),o.note.css("left",t),UserInfo.NotebookWidth=e,UserInfo.NoteListWidth=t)}},setMediaWidth:function(e){var t=this;e>=830&&1400>=e&&(t.noteAndEditor.width(e-t.leftNotebook.width()),t.note.width(e-t.leftNotebook.width()-t.noteList.width()),t.mediaSplitter.css("left",e),t.media.css("left",e))},resize3Columns:function(e,t){var o=this;t&&(e.clientX+=o.body.width()-o.note.width());var a,n;o.lineMove&&("notebookSplitter"==o.target?(a=e.clientX,n=o.noteList.width(),o.set3ColumnsWidth(a,n)):"noteSplitter"==o.target?(a=o.leftNotebook.width(),n=e.clientX-a,o.set3ColumnsWidth(a,n)):(a=e.clientX,o.setMediaWidth(a)))},resizeMDInterval:null,resizeMdColumns:function(e){var t=this;if(t.mdLineMove){var o=e.clientX-t.leftColumn.offset().left;t.setMdColumnWidth(o),clearInterval(t.resizeMDInterval),t.resizeMDInterval=setTimeout(function(){MD.resize&&MD.resize()},50)}},setMdColumnWidth:function(e){var t=this,o=$("#note").width();e>100&&o-80>e&&(UserInfo.MdEditorWidth=e,t.leftColumn.width(e),t.rightColumn.css("left",e)),MD&&MD.onResize()}};Mobile={noteO:$("#note"),bodyO:$("body"),setMenuO:$("#setMenu"),hashChange:function(){var e=Mobile,t=location.hash;if(-1!=t.indexOf("noteId")){e.toEditor(!1);var o=t.substr(8);Note.changeNote(o,!1,!1)}else e.toNormal(!1)},init:function(){var e=this;e.isMobile()},isMobile:function(){navigator.userAgent;return!1},changeNote:function(e){return!0},toEditor:function(e,t){var o=this;o.bodyO.addClass("full-editor"),o.noteO.addClass("editor-show")},toNormal:function(e){var t=this;t.bodyO.removeClass("full-editor"),t.noteO.removeClass("editor-show")},switchPage:function(){var e=this;return!LEA.isMobile||LEA.isIpad?!0:(e.bodyO.hasClass("full-editor")?e.toNormal(!0):e.toEditor(!0),!1)}};var random=1;LEA.s3=new Date,console.log("initing...(only reading app.min.js file)"),$(window).resize(function(){Mobile.isMobile()}),$(".folderHeader").click(function(){var e=$(this).next(),t=$(this).parent();e.is(":hidden")?($(".folderNote").removeClass("opened").addClass("closed"),t.removeClass("closed").addClass("opened"),$(this).find(".fa-angle-right").removeClass("fa-angle-right").addClass("fa-angle-down")):($(".folderNote").removeClass("opened").addClass("closed"),t.removeClass("opened").addClass("closed"),$(this).find(".fa-angle-down").removeClass("fa-angle-down").addClass("fa-angle-right"))}),$(".leanoteNav h1").on("click",function(e){var t=$(this).closest(".leanoteNav");t.hasClass("unfolder")?t.removeClass("unfolder"):t.addClass("unfolder")}),$("#wrongEmail").click(function(){openSetInfoDialog(1)}),$("#setTheme").click(function(){showDialog2("#setThemeDialog",{title:"主题设置",postShow:function(){UserInfo.Theme||(UserInfo.Theme="default"),$("#themeForm input[value='"+UserInfo.Theme+"']").attr("checked",!0)}})}),$("#themeForm").on("click","input",function(e){var t=$(this).val(),o=$("#themeLink").attr("href"),a=o.split("="),n=1;2==a.length&&(n=a[1]),$("#themeLink").attr("href","/css/theme/"+t+".css?id="+n),ajaxPost("/user/updateTheme",{theme:t},function(e){reIsOk(e)&&(UserInfo.Theme=t)})}),$("#notebook, #newMyNote, #myProfile, #topNav, #notesAndSort","#leanoteNavTrigger").bind("selectstart",function(e){return e.preventDefault(),!1});var $page=$("#page"),UerInfo={};$("#leftSwitcher2").on("click",function(){maxLeft(!0)}),$("#leftSwitcher").click("click",function(){Mobile.switchPage()&&minLeft(!0)}),$("#notebookMin div.minContainer").click(function(){var e=$(this).attr("target");maxLeft(!0),"#notebookList"==e?$("#myNotebooks").hasClass("closed")&&$("#myNotebooks .folderHeader").trigger("click"):"#tagNav"==e?$("##g").hasClass("closed")&&$("#myTag .folderHeader").trigger("click"):$("#myShareNotebooks").hasClass("closed")&&$("#myShareNotebooks .folderHeader").trigger("click")}),UserInfo.NotebookWidth=UserInfo.NotebookWidth||$("#notebook").width(),UserInfo.NoteListWidth=UserInfo.NoteListWidth||$("#noteList").width(),UserInfo.MediaWidth=UserInfo.MediaWidth||$("#media").width(),Resize.init(),Resize.set3ColumnsWidth(UserInfo.NotebookWidth,UserInfo.NoteListWidth,UserInfo.MediaWidth),Resize.setMdColumnWidth(UserInfo.MdEditorWidth),UserInfo.LeftIsMin?minLeft(!1):maxLeft(!1),$("#mainMask").html(""),$("#mainMask").hide(100),$(".dropdown").on("shown.bs.dropdown",function(){$(this).find("ul")}),Mobile.init();var Pjax={init:function(){var e=this;window.addEventListener("popstate",function(t){var o=t.state;o&&(document.title=o.title||"Untitled",log("pop"),e.changeNotebookAndNote(o.noteId))},!1),history.pushState||$(window).on("hashchange",function(){var t=getHash("noteId");t&&e.changeNotebookAndNote(t)})},changeNotebookAndNote:function(e){var t=Note.getNote(e);if(t){var o=void 0!=t.Perm,a=t.NotebookId;return Notebook.curNotebookId==a?void Note.changeNoteForPjax(e,!1):void(o?Share.changeNotebook(t.UserId,a,function(t){Note.renderNotes(t),Note.changeNoteForPjax(e,!1,!0)}):Notebook.changeNotebook(a,function(t){Note.renderNotes(t),Note.changeNoteForPjax(e,!1,!0)}))}if(t=Share.getNote(e)){var o=void 0!=t.Perm,a=t.NotebookId;return Notebook.curNotebookId==a?void Note.changeNoteForPjax(e,!1):void(o?Share.changeNotebook(t.UserId,a,function(t){Note.renderNotes(t),Note.changeNoteForPjax(e,!1,!0)}):Notebook.changeNotebook(a,function(t){Note.renderNotes(t),Note.changeNoteForPjax(e,!1,!0)}))}},changeNote:function(e){var t=e.NoteId,o=e.Title,a="/note/"+t;if(location.href.indexOf("?online")>0&&(a+="?online="+/online=([0-9])/.exec(location.href)[1]),location.hash&&(a+=location.hash),history.pushState){var n={url:a,noteId:t,title:o};history.pushState(n,o,a),document.title=o||"Untitled"}else setHash("noteId",t)}};$(function(){Pjax.init()}),LeaAce={_aceId:0,_aceEditors:{},_isInit:!1,_canAce:!1,isAce:!0,disableAddHistory:function(){tinymce.activeEditor.undoManager.setCanAdd(!1)},resetAddHistory:function(){tinymce.activeEditor.undoManager.setCanAdd(!0)},canAce:function(){return this._isInit?this._canAce:("webkit"!=getVendorPrefix()||Mobile.isMobile()?this._canAce=!1:this._canAce=!0,this._isInit=!0,this._canAce)},canAndIsAce:function(){return this.canAce()&&this.isAce},getAceId:function(){return this.aceId++,"leanote_ace_"+(new Date).getTime()+"_"+this._aceId},initAce:function(e,t,o){var a=this;if(o||a.canAndIsAce()){var n=$("#"+e);if(0!=n.length){var r=n.html();try{a.disableAddHistory();var i=n.attr("class")||"",s=-1!=i.indexOf("brush:html");(n.attr("style")||!s&&-1!=n.html().indexOf("style"))&&n.html(n.text()),n.find(".toggle-raw").remove(),n.html(),n.removeClass("ace-to-pre"),n.attr("contenteditable",!1);var l=ace.edit(e);l.container.style.lineHeight=1.5,l.setTheme("ace/theme/tomorrow");var c=a.getPreBrush(n),d="";if(c)try{d=c.split(":")[1]}catch(h){}return d&&"false"!==d||(d="javascript"),l.session.setMode("ace/mode/"+d),l.session.setOption("useWorker",!1),2==window.devicePixelRatio?l.setFontSize("12px"):l.setFontSize("14px"),l.getSession().setUseWorker(!1),l.setOption("showInvisibles",!1),l.setShowInvisibles(!1),l.setOption("wrap","free"),l.setShowInvisibles(!1),l.setReadOnly(Note.readOnly),l.setAutoScrollEditorIntoView(!0),l.setOption("maxLines",1e4),l.commands.addCommand({name:"undo",bindKey:{win:"Ctrl-z",mac:"Command-z"},exec:function(e){var t=e.getSession().getUndoManager();t.hasUndo()?t.undo():(t.reset(),tinymce.activeEditor.undoManager.undo())}}),this._aceEditors[e]=l,t&&l.setValue(t),a.resetAddHistory(),l}catch(h){console.error("ace error!!!!"),console.error(h),n.attr("contenteditable",!0),n.removeClass("ace-tomorrow ace_editor ace-tm"),n.html(r),a.resetAddHistory()}}}},clearIntervalForInitAce:null,initAceFromContent:function(e){if(!this.canAndIsAce()){var t=$(e.getBody());return void t.find("pre").removeClass("ace_editor")}var o=this;this.clearIntervalForInitAce&&clearInterval(this.clearIntervalForInitAce),this.clearIntervalForInitAce=setTimeout(function(){for(var t=$(e.getBody()),a=t.find("pre"),n=0;n<a.length;++n){var r=a.eq(n),i=o.isInAce(r);if(i){if(!isAceError(i[0].getValue()))break;console.error("之前有些没有destroy掉")}setTimeout(function(e){return function(){e.find(".toggle-raw").remove();var t=e.html();t=t.replace(/ /g,"&nbsp;").replace(/\<br *\/*\>/gi,"\n").replace(/</g,"&lt;").replace(/>/g,"&gt;"),e.html(t);var a=e.attr("id");a||(a=o.getAceId(),e.attr("id",a)),o.initAce(a)}}(r))}},10)},allToPre:function(e){if(this.canAndIsAce()){var t=this;t.clearIntervalForInitAce&&clearInterval(t.clearIntervalForInitAce),t.clearIntervalForInitAce=setTimeout(function(){for(var o=$(e.getBody()),a=o.find("pre"),n=0;n<a.length;++n){var r=a.eq(n);setTimeout(function(e){return function(){t.aceToPre(e)}}(r))}},10)}},undo:function(e){if(this.canAndIsAce()){var t=this;this.clearIntervalForInitAce&&clearInterval(this.clearIntervalForInitAce),this.clearIntervalForInitAce=setTimeout(function(){for(var o=$(e.getBody()),a=o.find("pre"),n=0;n<a.length;++n){var r=a.eq(n);setTimeout(function(e){return function(){var o=e.html(),a=e.attr("id"),n=t.getAce(a);if(n){var o=n.getValue();n.destroy();var n=t.initAce(a,o);n.selection.clearSelection()}else{o=o.replace(/ /g,"&nbsp;").replace(/\<br *\/*\>/gi,"\n"),e.html(o);var a=e.attr("id");a||(a=t.getAceId(),e.attr("id",a)),t.initAce(a)}}}(r))}},10)}},destroyAceFromContent:function(e){if(this.canAce())for(var t=e.find("pre"),o=0;o<t.length;++o){var a=t.eq(o).attr("id"),n=this.getAce(a);n&&(n.destroy(),this._aceEditors[a]=null)}},getAce:function(e){return this.canAce()?this._aceEditors[e]:void 0},setAceReadOnly:function(e,t){var o=this;if("object"==typeof e)var a=e.attr("id");else var a=e;var n=o.getAce(a);n&&n.setReadOnly(t)},nowIsInAce:function(){if(this.canAce()){var e=tinymce.activeEditor.selection.getNode();return this.isInAce(e)}},nowIsInPre:function(){var e=tinymce.activeEditor.selection.getNode();return this.isInPre(e)},isInPre:function(e){var t=$(e),e=t.get(0);return"PRE"==e.nodeName?!0:($pre=t.closest("pre"),0==$pre.length?!1:!0)},isInAce:function(e){if(this.canAce()){var t=$(e),e=t.get(0);if("PRE"==e.nodeName){var o=t.attr("id"),a=this.getAce(o);return a?[a,t]:!1}return $pre=t.closest("pre"),0==$pre.length?!1:this.isInAce($pre)}},getPreBrush:function(e){var t=$(e),o=t.attr("class");if(!o)return"";var a=o.match(/brush:[^ ]*/),n="";return a&&a.length>0&&(n=a[0]),n},preToAce:function(e,t){if(t||this.canAce()){var o=$(e),a=this.getAceId();o.attr("id",a);var n=this.initAce(a,"",!0);n&&n.focus()}},aceToPre:function(e,t){var o=this,a=$(e),n=o.isInAce(a);if(n){var r=n[0],a=n[1],i=r.getValue();isAceError(i)&&(i=a.html()),i=i.replace(/</g,"&lt").replace(/>/g,"&gt");var s=$('<pre class="'+a.attr("class")+' ace-to-pre">'+i+"</pre>");a.replaceWith(s),r.destroy(),o._aceEditors[a.attr("id")]=null,t&&setTimeout(function(){var e=tinymce.activeEditor,t=e.selection,o=t.getRng();o.selectNode(s.get(0)),e.focus(),s.trigger("click"),s.html(i+" ")},0)}},removeAllToggleRaw:function(){$("#editorContent .toggle-raw").remove()},removeCurToggleRaw:function(){if(this.curToggleRaw)try{this.curToggleRaw.remove()}catch(e){}},curToggleRaw:null,handleEvent:function(){if(this.canAce()){var e=this;$("#editorContent").on("mouseenter","pre",function(t){var o=$(this);if($raw=o.find(".toggle-raw"),0==$raw.length){var a=$('<div class="toggle-raw" title="Toggle code with raw html"><input type="checkbox" /></div>');o.append(a),e.curToggleRaw=a}$input=o.find(".toggle-raw input"),LeaAce.isInAce(o)?$input.prop("checked",!0):$input.prop("checked",!1)}),$("#editorContent").on("mouseleave","pre",function(){var e=$(this).find(".toggle-raw");e.remove()}),$("#editorContent").on("change",".toggle-raw input",function(){var t=$(this).prop("checked"),o=$(this).closest("pre");t?e.preToAce(o,!0):e.aceToPre(o,!0);
});var t;$("#editorContent").on("keyup","pre",function(o){var a=o.keyCode;if(8==a||46==a)if(t){var n=(new Date).getTime();if(300>n-t){var r=e.isInAce($(this));if(r&&!r[0].getValue())return r[0].destroy(),void $(this).remove()}t=n}else t=(new Date).getTime()})}}},Tag.classes={"蓝色":"label label-blue","红色":"label label-red","绿色":"label label-green","黄色":"label label-yellow",blue:"label label-blue",red:"label label-red",green:"label label-green",yellow:"label label-yellow"},Tag.mapCn2En={"蓝色":"blue","红色":"red","绿色":"green","黄色":"yellow"},Tag.mapEn2Cn={blue:"蓝色",red:"红色",green:"绿色",yellow:"黄色"},Tag.t=$("#tags"),Tag.getTags=function(){var e=[];return Tag.t.children().each(function(){var t=$(this).data("tag");t=Tag.mapCn2En[t]||t,e.push(t)}),e},Tag.clearTags=function(){Tag.t.html("")},Tag.renderTags=function(e){if(Tag.t.html(""),!isEmpty(e))for(var t=0;t<e.length;++t){var o=e[t];Tag.appendTag(o)}},Tag.renderReadOnlyTags=function(e){function t(){return o?"label label-default":(o=!0,"label label-info")}$("#noteReadTags").html(""),(isEmpty(e)||1==e.length&&""==e[0])&&$("#noteReadTags").html(getMsg("noTag"));var o=!0;for(var o in e){var a=e[o];a=Tag.mapEn2Cn[a]||a;var n=Tag.classes[a];n||(n=t()),tag=tt('<span class="?">?</span>',n,trimTitle(a)),$("#noteReadTags").append(tag)}},Tag.appendTag=function(e,t){var o,a,n=!1;console.log("start");var r=e;if("object"==typeof e){if(o=e.classes,a=e.text,!a)return}else{if(e=$.trim(e),a=e,!a)return;var o=Tag.classes[a];o?n=!0:o="label label-default"}e=tt('<span class="?" data-tag="?">?<i title="'+getMsg("delete")+'"> x</i></span>',o,a,a);var i=!1;$("#tags").children().each(function(){if(n){var t=$("<div></div>").append($(this).clone()).html();t==e&&($(this).remove(),i=!0)}else a+" x"==$(this).text()&&($(this).remove(),i=!0)}),$("#tags").append(e),hideTagList(),n||reRenderTags();var s={Count:1,CreatedTime:getCurDate(),IsDeleted:!1,Tag:r,TagId:getObjectId(),UpdatedTime:getCurDate(),UserId:UserInfo.UserId,Usn:94};t&&(i||Note.curChangedSaveIt(!0),Tag.addTagNav(s))},Tag.removeTag=function(e){var t=e.data("tag");e.remove(),reRenderTags(),Note.curChangedSaveIt(!0,function(){ajaxPost("/tag/updateTag",{tag:t},function(e){reIsOk(e)&&Tag.addTagNav(e.Item)})})},Tag.tags=[],Tag.initializeTagHint=function(){$("#tagColor").empty();for(var e in Tag.tags){var t=Tag.tags[e],o='<li role="presentation"><span class="label label-red">'+t.Tag+"</span></li>";$("#tagColor").append(o)}$("#tagColor li").click(function(e){console.log("here");var t;t=$(this).attr("role")?$(this).find("span"):$(this),Tag.appendTag(t.html())})},Tag.renderTagNav=function(e){e=e||[],Tag.tags=e,$("#tagNav").html("");for(var t in e){var o=e[t],a=o.Tag,n=a;n=trimTitle(n);var r=Tag.classes[a]||"label label-default";$("#tagNav").append(tt('<li data-tag="?"><a> <span class="?">?</span> <span class="tag-delete"><i class="fa fa-times" aria-hidden="true"></i></span></li>',a,r,n))}},Tag.addTagNav=function(e){var t=this;for(var o in t.tags){var a=t.tags[o];if(a.Tag==e.Tag){t.tags.splice(o,1);break}}t.tags.unshift(e),t.renderTagNav(t.tags),showMsg("New tag added"),Tag.initializeTagHint()},Tag.deleteTagNav=function(e){var t=this;for(var o in t.tags){var a=t.tags[o];if(a.Tag==e){t.tags.splice(o,1);break}}},$(function(){function e(){$li=$(this).closest("li");var e=$.trim($li.data("tag"));bootbox.confirm("Please confirm to delete this tag: "+e,function(o){if(o){t.Item;Note.deleteNoteTag(e),$li.remove(),Tag.deleteTagNav(e)}})}function t(){var e=$(this).closest("li"),t=$.trim(e.data("tag"));if(Note.curChangedSaveIt(),Note.clearAll(),$("#tagSearch").html(e.html()).show(),$("#tagSearch .tag-delete").remove(),e){var o=searchNotesByTagName(t);Note.renderNotes(o),isEmpty(o)||Note.changeNote(o[0].NoteId)}}$("#addTagTrigger").click(function(){$(this).hide(),$("#addTagInput").show().focus().val("")}),$("#addTagInput").click(function(e){showTagList(e)}),$("#addTagInput").blur(function(){var e=$(this).val();e&&Tag.appendTag(e,!0)}),$("#addTagInput").keydown(function(e){13==e.keyCode&&(hideTagList(),$("#addTagInput").val()?($(this).trigger("blur"),$("#addTagTrigger").trigger("click")):$(this).trigger("blur"))}),$("#tags").on("click","i",function(){Tag.removeTag($(this).parent())}),$("#myTag .folderBody").on("click","li .label",t),$("#myTag .folderBody").on("click","li .tag-delete",e)}),Notebook.curNotebookId="",Notebook.cache={},Notebook.notebooks=[],Notebook.notebookNavForListNote="",Notebook.notebookNavForNewNote="",Notebook.setCache=function(e){var t=e.NotebookId;t&&(Notebook.cache[t]||(Notebook.cache[t]={}),$.extend(Notebook.cache[t],e))},Notebook.getCurNotebookId=function(){return Notebook.curNotebookId},Notebook.getCurNotebook=function(){return Notebook.cache[Notebook.curNotebookId]},Notebook._updateNotebookNumberNotes=function(e,t){var o=this,a=o.getNotebook(e);a&&(a.NumberNotes+=t,a.NumberNotes<0&&(a.NumberNotes=0),$("#numberNotes_"+e).html(a.NumberNotes))},Notebook.incrNotebookNumberNotes=function(e){var t=this;t._updateNotebookNumberNotes(e,1)},Notebook.minusNotebookNumberNotes=function(e){var t=this;t._updateNotebookNumberNotes(e,-1)},Notebook.getNotebook=function(e){return Notebook.cache[e]},Notebook.getNotebookTitle=function(e){var t=Notebook.cache[e];return t?t.Title:"未知"},Notebook.getTreeSetting=function(e,t){function o(e,o){var a=5,n=$("#"+e+" #"+o.tId+"_switch"),r=$("#"+e+" #"+o.tId+"_ico");if(n.remove(),r.before(n),t?Share.isDefaultNotebookId(o.NotebookId)||r.after($('<span class="fa notebook-setting" title="setting"></span>')):Notebook.isAllNotebookId(o.NotebookId)||Notebook.isTrashNotebookId(o.NotebookId)||(r.after($('<span class="notebook-number-notes" id="numberNotes_'+o.NotebookId+'">'+(o.NumberNotes||0)+"</span>")),r.after($('<span class="fa notebook-setting" title="setting"></span>'))),o.level>1){var i="<span style='display: inline-block;width:"+a*o.level+"px'></span>";n.before(i)}}function a(e,t){for(var o=0,a=t.length;a>o;o++)if(t[o].drag===!1)return!1;return!0}function n(e,t,o,a){return o?o.drop!==!1:!0}function r(e,t,o,a,n){var r,l=o[0];if(a){var c,d=s.tree,h={curNotebookId:i.NotebookId};if(c="inner"==n?a:a.getParentNode()){var u=c.NotebookId;Notebook.cache[l.NotebookId].ParentNotebookId=u,l.ParentNotebookId=u,h.parentNotebookId=u;c.level+1}else r=d.getNodes();setTimeout(function(){Notebook.changeNav()},100)}}var i=!e,s=this;if(t)var l=function(e,t,o){var a=o.NotebookId,n=$(e.target).closest(".friend-notebooks").attr("fromUserId");Share.changeNotebook(n,a)},c=null;else var l=function(e,t,o){var a=o.NotebookId;Notebook.changeNotebook(a)},c=function(e){var t=$(e.target).attr("notebookId");Notebook.isAllNotebookId(t)||Notebook.isTrashNotebookId(t)||s.updateNotebookTitle(e.target)};var d={view:{showLine:!1,showIcon:!1,selectedMulti:!1,dblClickExpand:!1,addDiyDom:o},data:{key:{name:"Title",children:"Subs"}},edit:{enable:!0,showRemoveBtn:!1,showRenameBtn:!1,drag:{isMove:i,prev:i,inner:i,next:i}},callback:{beforeDrag:a,beforeDrop:n,onDrop:r,onClick:l,onDblClick:c,beforeRename:function(e,t,o,a){if(""==o)return t.IsNew?(s.tree.removeNode(t),!0):!1;if(t.Title==o)return!0;if(t.IsNew){var n=t.getParentNode(),r=n?n.NotebookId:"";s.doAddNotebook(t.NotebookId,o,r)}else s.doUpdateNotebookTitle(t.NotebookId,o);return!0}}};return d},Notebook.allNotebookId="0",Notebook.trashNotebookId="-1",Notebook.curNotebookIsTrashOrAll=function(){return Notebook.curNotebookId==Notebook.trashNotebookId||Notebook.curNotebookId==Notebook.allNotebookId},Notebook.renderNotebooks=function(e){var t,o,a=this;(!e||"object"!=typeof e||e.length<0)&&(e=[]);for(var n=0,r=e.length;r>n;++n){var i=e[n];i.Title=trimTitle(i.Title),"-1"==i.NotebookId&&(o=n,t=i)}void 0!=t&&(e.splice(o,1),e.push(t)),Notebook.notebooks=e;var s=[];for(var l in e){var c=e[l];c.ParentNotebookId||s.push(c)}a.tree=$.fn.notebookZTree.init($("#notebookList"),a.getTreeSetting(),s);var d=$("#notebookList");d.hover(function(){$(this).hasClass("showIcon")||$(this).addClass("showIcon")},function(){$(this).removeClass("showIcon")}),isEmpty(e)||(Notebook.curNotebookId=e[0].NotebookId,a.cacheAllNotebooks(e)),Notebook.renderNav()},Notebook.cacheAllNotebooks=function(e){var t=this;for(var o in e){var a=e[o];Notebook.cache[a.NotebookId]=a,isEmpty(a.Subs)||t.cacheAllNotebooks(a.Subs)}},Notebook.expandNotebookTo=function(e,t){var o=this,a=!1,n=o.tree;if(t&&(n=Share.trees[t]),n){var r=n.getNodeByTId(e);if(r)for(;;){var i=r.getParentNode();if(!i){a||Notebook.changeNotebookNav(e);break}n.expandNode(i,!0),a||(Notebook.changeNotebookNav(e),a=!0),r=i}}},Notebook.renderNav=function(e){var t=this;t.changeNav()},Notebook.searchNotebookForAddNote=function(e){var t=this;if(e){var o=t.tree.getNodesByParamFuzzy("Title",e);o=o||[];var a=[];for(var n in o){var r=o[n].NotebookId;t.isAllNotebookId(r)||t.isTrashNotebookId(r)||a.push(o[n])}isEmpty(a)?$("#notebookNavForNewNote").html(""):$("#notebookNavForNewNote").html(t.getChangedNotebooks(a))}else $("#notebookNavForNewNote").html(t.everNavForNewNote)},Notebook.searchNotebookForList=function(e){var t=this,o=$("#notebookListForSearch"),a=$("#notebookList");if(e){o.show(),a.hide();var n=t.tree.getNodesByParamFuzzy("Title",e);if(log("search"),log(n),isEmpty(n))o.html("");else{var r=t.getTreeSetting(!0);t.tree2=$.fn.notebookZTree.init(o,r,n)}}else t.tree2=null,o.hide(),a.show(),$("#notebookNavForNewNote").html(t.everNavForNewNote)},Notebook.getChangedNotebooks=function(e){for(var t=this,o="",a=e.length,n=0;a>n;++n){var r=e[n],i="";isEmpty(r.Subs)||(i="dropdown-submenu");var s=tt('<li role="presentation" class="clearfix ?"><div class="new-note-left pull-left" title="为该笔记本新建笔记" href="#" notebookId="?">?</div><div title="为该笔记本新建markdown笔记" class="new-note-right pull-left" notebookId="?">M</div>',i,r.NotebookId,r.Title,r.NotebookId);isEmpty(r.Subs)||(s+="<ul class='dropdown-menu'>",s+=t.getChangedNotebooks(r.Subs),s+="</ul>"),s+="</li>",o+=s}return o},Notebook.everNavForNewNote="",Notebook.everNotebooks=[],Notebook.changeNav=function(){var e=Notebook,t=Notebook.tree.getNodes(),o=[];for(var a in t){var n=t[a];"0"!=n.NotebookId&&"-1"!=n.NotebookId&&o.push(n)}var r=e.getChangedNotebooks(o);e.everNavForNewNote=r,e.everNotebooks=o,$("#notebookNavForNewNote").html(r),Note.initContextmenu(),Share.initContextmenu(Note.notebooksCopy)},Notebook.selectNotebook=function(e){$(".notebook-item").removeClass("curSelectedNode"),$(e).addClass("curSelectedNode")},Notebook.changeNotebookNavForNewNote=function(e,t){if(!e){var o=Notebook.notebooks[0];e=o.NotebookId,t=o.Title}if(!t){var o=Notebook.cache[0];t=o.Title}if(Notebook.isAllNotebookId(e)||Notebook.isTrashNotebookId(e)){if(!$("#curNotebookForNewNote").attr("notebookId")&&Notebook.notebooks.length>2){var o=Notebook.notebooks[1];e=o.NotebookId,t=o.Title,Notebook.changeNotebookNavForNewNote(e,t)}}else $("#curNotebookForNewNote").html(t).attr("notebookId",e)},Notebook.toggleToMyNav=function(e,t){$("#sharedNotebookNavForListNav").hide(),$("#myNotebookNavForListNav").show(),$("#newMyNote").show(),$("#newSharedNote").hide(),$("#tagSearch").hide()},Notebook.changeNotebookNav=function(e){Notebook.curNotebookId=e,Notebook.toggleToMyNav(),Notebook.selectNotebook($(tt('#notebook [notebookId="?"]',e)));var t=Notebook.cache[e];t&&($("#curNotebookForListNote").html(t.Title),Notebook.changeNotebookNavForNewNote(e,t.Title))},Notebook.isAllNotebookId=function(e){return e==Notebook.allNotebookId},Notebook.isTrashNotebookId=function(e){return e==Notebook.trashNotebookId},Notebook.curActiveNotebookIsAll=function(){return Notebook.isAllNotebookId($("#notebookList .curSelectedNode").attr("notebookId"))},Notebook.curActiveNotebookIsTrash=function(){return Notebook.isTrashNotebookId($("#notebookList .curSelectedNode").attr("notebookId"))},Notebook.changeNotebookSeq=1,Notebook.changeNotebook=function(e,t){var o=this;Notebook.changeNotebookNav(e),Notebook.curNotebookId=e,Note.curChangedSaveIt(),Note.clearAll();var a="/note/listNotes/",n={notebookId:e};if(Notebook.isTrashNotebookId(e))return a="/note/listTrashNotes",n={},cacheNotes=Note.getNotesByNotebookId(-1),void(t?t(cacheNotes):Note.renderNotesAndFirstOneContent(cacheNotes));if(Notebook.isAllNotebookId(e))return n={},cacheNotes=Note.getNotesByNotebookId(),void(t?t(cacheNotes):Note.renderNotesAndFirstOneContent(cacheNotes));cacheNotes=Note.getNotesByNotebookId(e);var r=Notebook.cache[e],i=cacheNotes?cacheNotes.length:0;return i==r.NumberNotes?void(t?t(cacheNotes):Note.renderNotesAndFirstOneContent(cacheNotes)):(Note.clearCacheByNotebookId(e),o.showNoteAndEditorLoading(),o.changeNotebookSeq++,function(e){ajaxGet(a,n,function(a){return e!=o.changeNotebookSeq?(log("notebook changed too fast!"),void log(a)):(t?t(a):Note.renderNotesAndFirstOneContent(a),void o.hideNoteAndEditorLoading())})}(o.changeNotebookSeq),void 0)},Notebook.showNoteAndEditorLoading=function(){$("#noteAndEditorMask").show()},Notebook.hideNoteAndEditorLoading=function(){$("#noteAndEditorMask").hide()},Notebook.isCurNotebook=function(e){return"active"==$(tt('#notebookList [notebookId="?"], #shareNotebooks [notebookId="?"]',e,e)).attr("class")},Notebook.changeNotebookForNewNote=function(e){Notebook.isTrashNotebookId(e)||Notebook.isAllNotebookId(e)||(Notebook.changeNotebookNav(e,!0),Notebook.curNotebookId=e,Note.renderNotes(e,!0))},Notebook.listNotebookShareUserInfo=function(e){var t=$(e).attr("notebookId");Share.dialogNoteOrNotebookId=t,Share.dialogIsNote=0,showDialogRemote("/share/listNotebookShareUserInfo",{notebookId:t})},Notebook.shareNotebooks=function(e){var t=$(e).text();showDialog("dialogShareNote",{title:"分享笔记本给好友-"+t}),setTimeout(function(){$("#friendsEmail").focus()},500);var o=$(e).attr("notebookId");shareNoteOrNotebook(o,!1)},Notebook.updateNotebookTitle=function(e){var t=Notebook,o=$(e).attr("notebookId");t.tree2?t.tree2.editName(t.tree2.getNodeByTId(o)):t.tree.editName(t.tree.getNodeByTId(o))},Notebook.doUpdateNotebookTitle=function(e,t){var o=Notebook;ajaxPost("/notebook/updateNotebookTitle",{notebookId:e,title:t},function(a){if(Notebook.cache[e].Title=t,Notebook.changeNav(),o.tree2){var n=o.tree.getNodeByTId(e);n.Title=t,o.tree.updateNode(n)}})},Notebook.addNotebookSeq=1,Notebook.addNotebook=function(){var e=Notebook;$("#myNotebooks").hasClass("closed")&&$("#myNotebooks .folderHeader").trigger("click"),e.tree.addNodes(null,{Title:"",NotebookId:getObjectId(),IsNew:!0},!0,!0)},Notebook.doAddNotebook=function(e,t,o){var a=Notebook,n={IsTrash:!1,CreatedTime:getCurDate(),UpdateTime:getCurDate(),NumberNotes:0,IsTrash:!1,IsDeleted:!1,NotebookId:e,Title:t,ParentNotebookId:o,Subs:[]};Notebook.cache[n.NotebookId]=n;var o=a.tree.getNodeByTId(e);$.extend(o,n),o.IsNew=!1,Notebook.changeNotebook(e),Notebook.changeNav(),showMsg("New notebook created")},Notebook.addChildNotebook=function(e){var t=Notebook;$("#myNotebooks").hasClass("closed")&&$("#myNotebooks .folderHeader").trigger("click");var o=$(e).attr("notebookId");t.tree.addNodes(t.tree.getNodeByTId(o),{Title:"",NotebookId:getObjectId(),IsNew:!0},!1,!0)},Notebook.deleteNotebook=function(e){var t=Notebook,o=$(e).attr("notebookId"),a=Notebook.cache[o].Title;a&&bootbox.confirm("Please confirm to delete notebook: "+a,function(e){if(e){t.tree.removeNode(t.tree.getNodeByTId(o)),t.tree2&&t.tree2.removeNode(t.tree2.getNodeByTId(o));var a=Notebook.cache[o].Subs;if(a)for(var n in a)Notebook.deleteNotebookHelper(a[n].NotebookId);var r=Notebook.cache[Notebook.cache[o].ParentNotebookId];if(r){var a=r.Subs;for(var n in a)"curNotebookId"==a.NotebookId&&a.splice(n,1)}delete Notebook.cache[o],Note.clearCacheByNotebookId(o),delete Note.cacheByNotebookId[o];for(var n in Note.cache){var i=Note.cache[n];i.NotebookId==o&&delete Note.cache[n]}Notebook.changeNav()}})},Notebook.deleteNotebookHelper=function(e){var t=Notebook.cache[e].Subs;if(t)for(var o in t)Notebook.deleteNotebookHelper(t[o].NotebookId);delete Notebook.cache[e],Note.clearCacheByNotebookId(e),delete Note.cacheByNotebookId[e];for(var o in Note.cache){var a=Note.cache[o];a.NotebookId==e&&delete Note.cache[o]}},$(function(){function e(e){var t=$(this).attr("notebookId"),o=Notebook.cache[t];if(o){var a=[];o.IsBlog?a.push("set2Blog"):a.push("unset2Blog"),Note.notebookHasNotes(t)&&a.push("delete"),e.applyrule({name:"target2",disable:!0,items:a})}}function t(){var e=$(this).attr("notebookId");return!Notebook.isTrashNotebookId(e)&&!Notebook.isAllNotebookId(e)}$("#minNotebookList").on("click","li",function(){var e=$(this).find("a").attr("notebookId");Notebook.changeNotebook(e)});var o={width:180,items:[{text:getMsg("shareToFriends"),alias:"shareToFriends",icon:"",faIcon:"fa-share-square-o",action:Notebook.listNotebookShareUserInfo},{type:"splitLine"},{text:getMsg("addChildNotebook"),faIcon:"fa-sitemap",action:Notebook.addChildNotebook},{text:getMsg("rename"),faIcon:"fa-pencil",action:Notebook.updateNotebookTitle},{text:getMsg("delete"),faIcon:"fa-trash-o",action:Notebook.deleteNotebook}],onShow:e,onContextMenu:t,parent:"#notebookList ",children:"li a"},a={width:180,items:[{text:getMsg("shareToFriends"),alias:"shareToFriends",icon:"",faIcon:"fa-share-square-o",action:Notebook.listNotebookShareUserInfo},{type:"splitLine"},{type:"splitLine"},{text:getMsg("rename"),icon:"",action:Notebook.updateNotebookTitle},{text:getMsg("delete"),icon:"",alias:"delete",faIcon:"fa-trash-o",action:Notebook.deleteNotebook}],onShow:e,onContextMenu:t,parent:"#notebookListForSearch ",children:"li a"};Notebook.contextmenu=$("#notebookList li a").contextmenu(o),Notebook.contextmenuSearch=$("#notebookListForSearch li a").contextmenu(a),$("#addNotebookPlus").click(function(e){e.stopPropagation(),Notebook.addNotebook()}),$("#notebookList").on("click",".notebook-setting",function(e){e.preventDefault(),e.stopPropagation();var t=$(this).parent();Notebook.contextmenu.showMenu(e,t)}),$("#notebookListForSearch").on("click",".notebook-setting",function(e){e.preventDefault(),e.stopPropagation();var t=$(this).parent();Notebook.contextmenuSearch.showMenu(e,t)})}),Share.defaultNotebookId="share0",Share.defaultNotebookTitle=getMsg("defaultShare"),Share.sharedUserInfos={},Share.userNavs={},Share.notebookCache={},Share.cache={},Share.dialogIsNote=!1,Share.setCache=function(e){e&&e.NoteId&&(Share.cache[e.NoteId]=e)},Share.getNote=function(e){var t=this;return t.cache[e]},Share.getNotebooksForNew=function(e,t){for(var o=this,a="",n=t.length,r=0;n>r;++r){var i=t[r];i.IsShared=!0,i.UserId=e,o.notebookCache[i.NotebookId]=i;var s="",l=!1;if(!isEmpty(i.Subs)){log(11),log(i.Subs);var l=o.getNotebooksForNew(e,i.Subs);l&&(s="dropdown-submenu")}var c="";if(i.Perm){var c=tt('<li role="presentation" class="clearfix ?" userId="?" notebookId="?"><div class="new-note-left pull-left" title="为该笔记本新建笔记" href="#">?</div><div title="为该笔记本新建markdown笔记" class="new-note-right pull-left">M</div>',s,e,i.NotebookId,i.Title);l&&(c+="<ul class='dropdown-menu'>",c+=l,c+="</ul>"),c+="</li>"}a+=c}return a},Share.trees={},Share.renderShareNotebooks=function(e,t){function o(e){}function a(){var e=$(this).attr("notebookId");return!Share.isDefaultNotebookId(e)}console.log("before"),console.log(Notebook.cache);var n=Share;if(!isEmpty(e)){(!t||"object"!=typeof t||t.length<0)&&(t={});var r=$("#shareNotebooks");for(var i in e){var s=e[i],l=t[s.UserId]||[],c=[{NotebookId:n.defaultNotebookId,Title:Share.defaultNotebookTitle}].concat(l);n.notebookCache[n.defaultNotebookId]=c[0];var d=s.Username||s.Email;s.Username=d,Share.sharedUserInfos[s.UserId]=s;var h=s.UserId,u=tt('<li class="each-user"><div class="friend-header" fromUserId="?"><i class="fa fa-angle-down"></i><span>?</span> <span class="fa notebook-setting" title="setting"></span> </div>',s.UserId,d),N="friendContainer_"+h,f='<ul class="friend-notebooks ztree" id="'+N+'" fromUserId="'+h+'"></ul>';r.append(u+f+"</li>"),n.trees[h]=$.fn.notebookZTree.init($("#"+N),Notebook.getTreeSetting(!0,!0),c),n.userNavs[h]={forNew:n.getNotebooksForNew(h,l)},log(n.userNavs),console.log(Notebook.cache)}$(".friend-notebooks").hover(function(){$(this).hasClass("showIcon")||$(this).addClass("showIcon")},function(){$(this).removeClass("showIcon")}),$(".friend-header i").click(function(){var e=$(this),t=$(this).parent().next();t.is(":hidden")?(t.slideDown("fast"),e.removeClass("fa-angle-right fa-angle-down").addClass("fa-angle-down")):(t.slideUp("fast"),e.removeClass("fa-angle-right fa-angle-down").addClass("fa-angle-right"))});var g={width:180,items:[{text:getMsg("deleteSharedNotebook"),icon:"",faIcon:"fa-trash-o",action:Share.deleteShareNotebook}],onShow:o,onContextMenu:a,parent:"#shareNotebooks",children:".notebook-item"},b=$("#shareNotebooks").contextmenu(g),v={width:180,items:[{text:"Delete shared user",icon:"",faIcon:"fa-trash-o",action:Share.deleteUserShareNoteAndNotebook}],parent:"#shareNotebooks",children:".friend-header"},m=$("#shareNotebooks").contextmenu(v);$(".friend-header").on("click",".notebook-setting",function(e){e.preventDefault(),e.stopPropagation();var t=$(this).parent();m.showMenu(e,t)}),$("#shareNotebooks .notebook-item").on("click",".notebook-setting",function(e){e.preventDefault(),e.stopPropagation();var t=$(this).parent();b.showMenu(e,t)})}},Share.isDefaultNotebookId=function(e){return Share.defaultNotebookId==e},Share.toggleToSharedNav=function(e,t){$("#curNotebookForListNote").html(Share.notebookCache[t].Title+"("+Share.sharedUserInfos[e].Username+")");var o=Share.userNavs[e].forNew;if(o){$("#notebookNavForNewSharedNote").html(o);var a="",n="";if(Share.notebookCache[t].Perm)a=t,n=Share.notebookCache[t].Title;else{var r=$("#notebookNavForNewSharedNote li").eq(0);a=r.attr("notebookId"),n=r.find(".new-note-left").text()}$("#curNotebookForNewSharedNote").html(n+"("+Share.sharedUserInfos[e].Username+")"),$("#curNotebookForNewSharedNote").attr("notebookId",a),$("#curNotebookForNewSharedNote").attr("userId",e),$("#newSharedNote").show(),$("#newMyNote").hide()}else $("#newMyNote").show(),$("#newSharedNote").hide();$("#tagSearch").hide()},Share.firstRenderShareNote=function(e,t,o){$("#myShareNotebooks .folderHeader").trigger("click"),Notebook.expandNotebookTo(t,e),Share.changeNotebook(e,t,function(e){Note.renderNotes(e),Note.changeNoteForPjax(o,!1,!1)})},Share.changeNotebook=function(e,t,o){var a=this;Notebook.curNotebookId=t;var n=$(tt('#friendContainer_? a[notebookId="?"]',e,t));0==n.length?(Notebook.selectNotebook($(tt('#friendContainer_? a[notebookId="?"]',e,a.defaultNotebookId))),t=a.defaultNotebookId):Notebook.selectNotebook(n),Share.toggleToSharedNav(e,t),Note.curChangedSaveIt(),Note.clearAll();var r=normUrl+"share/listShareNotes";$.ajax({type:"GET",url:r,data:"UserId="+e+"&NotebookId="+t+"&CurUserId="+UserId,contentType:"text/plain",success:function(t){var a=jQuery.parseJSON(t);"fail"==a.status?bootbox.alert(a.msg,function(){}):(console.log(a),o?o(e):(Note.renderNotes(a,!1,!0),isEmpty(a)||Note.changeNoteForPjax(a[0].NoteId,!0,!1)))},error:function(e,t,o){bootbox.alert(getMsg("ServerCrashes"),function(){})}})},Share.hasUpdatePerm=function(e){var t=Share.cache[e];return t||(t=Note.getNote(e)),t&&t.Perm?!0:!1},Share.deleteShareNotebook=function(e){var t=$(e).attr("notebookId"),o=$(e).closest(".friend-notebooks").attr("fromUserId"),a=shareNotebooks[o],n=-1;for(var r in a){var i=a[r];if(i.NotebookId==t){n=r;break}}var s={};if(n>=0&&(s=a[n])){var l=s.Title;bootbox.confirm("Please confirm to delete this share notebook: "+l,function(t){t&&($(e).parent().remove(),a.splice(n,1),shareNotebooks[o]=a)})}},Share.deleteShareNote=function(e){var t=$(e).attr("noteId"),o=$(e).attr("fromUserId");ajaxGet("/share/DeleteShareNoteBySharedUser",{noteId:t,fromUserId:o},function(t){t&&$(e).remove()})},Share.deleteUserShareNoteAndNotebook=function(e){var t=$(e).attr("fromUserId");for(var o in sharedUserInfos)if(sharedUserInfos[o].UserId==t){bootbox.confirm("Please confirm to delete the share user: "+sharedUserInfos[o].Username,function(a){a&&($(e).parent().remove(),sharedUserInfos.splice(o,1),delete shareNotebooks[t])});break}},Share.changeNotebookForNewNote=function(e){Notebook.selectNotebook($(tt('#shareNotebooks [notebookId="?"]',e)));var t=Share.notebookCache[e].UserId;Share.toggleToSharedNav(t,e);var o="/share/listShareNotes",a={userId:t,notebookId:e};ajaxGet(o,a,function(e){Note.renderNotes(e,!0,!0)})},Share.deleteSharedNote=function(e,t){Note.deleteNote(e,t,!0)},Share.copySharedNote=function(e,t){Note.copyNote(e,t,!0)},Share.contextmenu=null,Share.initContextmenu=function(e){function t(e){var t=$(this).attr("noteId"),o=Note.getNote(t),a=[];(Note.inBatch||!o)&&a.push("delete"),!o||o.Perm&&o.CreatedUserId==UserInfo.UserId||a.push("delete"),e.applyrule({name:"target...",disable:!0,items:a})}Share.contextmenu&&Share.contextmenu.destroy();var o={width:180,items:[{text:getMsg("copyToMyNotebook"),alias:"copy",faIcon:"fa-copy",type:"group",width:180,items:e},{type:"splitLine"},{text:getMsg("delete"),alias:"delete",icon:"",faIcon:"fa-trash-o",action:Share.deleteSharedNote}],onShow:t,parent:"#noteItemList",children:".item-shared"};Share.contextmenu=$("#noteItemList .item-shared").contextmenu(o)},$(function(){$("#noteItemList").on("click",".item-shared .item-setting",function(e){e.preventDefault(),e.stopPropagation();var t=$(this).parent();Share.contextmenu.showMenu(e,t)}),$("#newSharedNoteBtn").click(function(){var e=$("#curNotebookForNewSharedNote").attr("notebookId"),t=$("#curNotebookForNewSharedNote").attr("userId");Note.newNote(e,!0,t)}),$("#newShareNoteMarkdownBtn").click(function(){var e=$("#curNotebookForNewSharedNote").attr("notebookId"),t=$("#curNotebookForNewSharedNote").attr("userId");Note.newNote(e,!0,t,!0)}),$("#notebookNavForNewSharedNote").on("click","li div",function(){var e=$(this).parent().attr("notebookId"),t=$(this).parent().attr("userId");"M"==$(this).text()?Note.newNote(e,!0,t,!0):Note.newNote(e,!0,t)}),$("#leanoteDialogRemote").on("click",".change-perm",function(){var e=this,t=$(this).attr("perm"),o=$(this).attr("noteOrNotebookId"),a=$(this).attr("toUserId"),n=getMsg("writable"),r="1";"1"==t&&(n=getMsg("readOnly"),r="0");var i="/share/updateShareNotebookPerm",s={perm:r,toUserId:a};Share.dialogIsNote?(i="share/updateShareNotePerm",s.noteId=o):s.notebookId=o,ajaxGet(i,s,function(t){t&&($(e).html(n),$(e).attr("perm",r))})}),$("#leanoteDialogRemote").on("click",".delete-share",function(){var e=this,t=$(this).attr("noteOrNotebookId"),o=$(this).attr("toUserId"),a="/share/deleteShareNotebook",n={toUserId:o};Share.dialogIsNote?(a="share/deleteShareNote",n.noteId=t):n.notebookId=t,ajaxGet(a,n,function(t){t&&$(e).parent().parent().remove()})});var e=1;$("#leanoteDialogRemote").on("click","#addShareNotebookBtn",function(){e++;var t='<tr id="tr'+e+'"><td><input id="friendsEmail" type="text" class="form-control" placeholder="Enter Account Name"/></td>';t+=' <td id = "sharebuttontd"><button id = "sharebutton" class="btn btn-success" onclick="addShareNoteOrNotebook('+e+')"><i class="fa fa-share" aria-hidden="true"></i>  '+getMsg("share")+"</button></td>",t+=' <td><button id = "deletebutton" class="btn btn-warning" onclick="deleteShareNoteOrNotebook('+e+')"><i class="fa fa-trash" aria-hidden="true"></i>  '+getMsg("delete")+"</button>",t+="</td></tr>",$("#shareNotebookTable tbody").prepend(t),$("#tr"+e+" #friendsEmail").focus()}),$("#registerEmailBtn").click(function(){var e=$("#emailContent").val(),t=$("#toEmail").val();return e?void post("/user/sendRegisterEmail",{content:e,toEmail:t},function(e){showAlert("#registerEmailMsg",getMsg("sendSuccess"),"success"),hideDialog2("#sendRegisterEmailDialog",1e3)},this):void showAlert("#registerEmailMsg",getMsg("emailBodyRequired"),"danger")}),$("#groupInfo").on("click",".btn-share-or-not",function(){var e=$(this),t=e.closest("td"),o=e.closest("tr"),a=o.data("uid");a=0;var n=o.data("id"),r={GroupId:n,SenderUserId:UserId},i="";if(a)Share.dialogIsNote?(r.NoteId=Share.dialogNoteOrNotebookId,i="/share/deleteShareNoteGroup"):(r.NotebookId=Share.dialogNoteOrNotebookId,i="/share/deleteShareNotebookGroup");else{var s=o.find("input:checked").val();r.Perm=s,Share.dialogIsNote?(r.NoteId=Share.dialogNoteOrNotebookId,i="share/addGroupShareNote"):(r.NotebookId=Share.dialogNoteOrNotebookId,i="share/addGroupShareNotebook")}i=normUrl+i;var l=JSON.stringify(r);$.ajax({type:"POST",url:i,data:l,contentType:"text/plain",success:function(e){var n=jQuery.parseJSON(e);if("success"==n.status){console.log("success");for(var i in n.ToUserIds)if(Share.dialogIsNote){var s=n.ToUserIds[i];void 0==shareNotebookDefault[s]&&(shareNotebookDefault[s]=[]);var l=0;for(var i in shareNotebookDefault[s]){var c=shareNotebookDefault[s][i];if(c.NoteId==r.NoteId){l=1;break}}l||(showAlert("#shareMsg","Sorry! This note has already been shared to the same user","danger"),shareNotebookDefault[s].push(r)),showAlert("#shareMsg",getMsg("ShareSuccess"),"success")}if(a){var d='<button class="btn btn-default btn-share-or-not"> Not shared </button>';o.data("uid","")}else{var d='<button id = "successbtn" class="btn btn-success btn-share-or-not"><i class="fa fa-trash" aria-hidden="true"></i> Delete </button>';o.data("uid","xxxxxx")}t.html(d)}else showAlert("#shareMsg",getMsg("ShareFail"),"danger")},error:function(e,t,o){console.log("Error: "+o.message),showAlert("#shareMsg",getMsg("ServerCrashes"),"danger")}})})}),window.onbeforeunload=onbeforeunload_handler;